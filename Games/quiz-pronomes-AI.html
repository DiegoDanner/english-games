<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz de Pronomes com IA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/theme.css" />
    <link rel="stylesheet" href="css/style.css" />
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">
    <div id="header-placeholder"></div>

    <div id="quiz" class="quiz-container bg-white p-6 sm:p-8 rounded-xl shadow-lg">
        
        <!-- Tela de Início -->
        <div id="welcome-screen" class="text-center">
            <h1 class="text-3xl font-bold text-gray-800 mb-2">Object Pronouns</h1>
            <p class="text-gray-600 mb-6">"Object pronouns" são pequenas palavras que substituem nomes para evitar repetição.</p>
            <div class="text-left my-6 space-y-2">
                <p class="flex items-center"><span class="flex-shrink-0 w-5 h-5 mr-2 text-blue-500"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5"><path fill-rule="evenodd" d="M3 10a.75.75 0 01.75-.75h10.638L10.23 5.29a.75.75 0 111.04-1.08l5.5 5.25a.75.75 0 010 1.08l-5.5 5.25a.75.75 0 11-1.04-1.08l4.158-3.96H3.75A.75.75 0 013 10z" clip-rule="evenodd" /></svg></span>Subject Pronouns são aqueles que fazem a ação na frase.</p>
                <p class="flex items-center"><span class="flex-shrink-0 w-5 h-5 mr-2 text-blue-500"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5"><path fill-rule="evenodd" d="M3 10a.75.75 0 01.75-.75h10.638L10.23 5.29a.75.75 0 111.04-1.08l5.5 5.25a.75.75 0 010 1.08l-5.5 5.25a.75.75 0 11-1.04-1.08l4.158-3.96H3.75A.75.75 0 013 10z" clip-rule="evenodd" /></svg></span>Object Pronouns são aqueles que recebem a ação na frase.</p>
            </div>
            <div class="w-full overflow-hidden rounded-lg shadow-md my-8">
                <table class="w-full text-sm text-left text-gray-500 pronoun-table">
                    <thead class="text-xs text-gray-700 uppercase bg-gray-200">
                        <tr>
                            <th scope="col" class="px-6 py-3">Subject Pronoun (pronome pessoal)</th>
                            <th scope="col" class="px-6 py-3">Object Pronoun (pronome oblíquo)</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr class="bg-white border-b"><td class="px-6 py-4">I</td><td class="px-6 py-4">me</td></tr>
                        <tr class="bg-gray-50 border-b"><td class="px-6 py-4">you</td><td class="px-6 py-4">you</td></tr>
                        <tr class="bg-white border-b"><td class="px-6 py-4">he</td><td class="px-6 py-4">him</td></tr>
                        <tr class="bg-gray-50 border-b"><td class="px-6 py-4">she</td><td class="px-6 py-4">her</td></tr>
                        <tr class="bg-white border-b"><td class="px-6 py-4">it</td><td class="px-6 py-4">it</td></tr>
                        <tr class="bg-gray-50 border-b"><td class="px-6 py-4">we</td><td class="px-6 py-4">us</td></tr>
                        <tr class="bg-white border-b"><td class="px-6 py-4">you</td><td class="px-6 py-4">you</td></tr>
                        <tr class="bg-gray-50"><td class="px-6 py-4">they</td><td class="px-6 py-4">them</td></tr>
                    </tbody>
                </table>
            </div>
            <button id="start-quiz-btn" class="btn w-full px-6 py-3 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-opacity-75 transition-transform transform hover:scale-105">Começar o Quiz!</button>
        </div>

        <!-- Seleção de Modo -->
        <div id="mode-selection" class="hidden text-center">
            <h1 class="text-2xl font-bold text-gray-800 mb-4">Quiz de Pronomes</h1>
            <p class="text-gray-600 mb-8">Escolha um modo para começar.</p>
            <div class="flex flex-col sm:flex-row gap-4">
                <button id="standard-quiz-btn" class="btn w-full px-6 py-3 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-opacity-75 transition-transform transform hover:scale-105">Quiz Padrão (10 Questões)</button>
                <button id="gemini-practice-btn" class="gemini-btn btn w-full px-6 py-3 bg-purple-600 text-white font-semibold rounded-lg shadow-md hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-opacity-75 transition-transform transform hover:scale-105">✨ Prática com IA</button>
            </div>
        </div>

        <!-- Estrutura do Quiz (inicialmente escondida) -->
        <div id="quiz-structure" class="hidden">
            <!-- Header do Quiz -->
            <div id="header-container" class="flex justify-between items-center mb-6">
                <h1 id="quiz-title" class="text-xl sm:text-2xl font-bold text-gray-800"></h1>
                <button id="back-to-menu" class="back-menu-btn text-sm font-semibold text-indigo-600 hover:underline">Menu</button>
            </div>
            
            <div id="progress-container">
                <div class="flex justify-between items-center mb-2">
                    <span class="text-sm font-medium text-gray-700">Progresso</span>
                    <span id="progress-text" class="text-sm font-semibold text-gray-600">Questão 1 de 10</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2.5 mb-6">
                    <div id="progress-bar" class="progress-bar bg-indigo-600 h-2.5 rounded-full" style="width: 10%"></div>
                </div>
            </div>

            <!-- Container da Questão -->
            <div id="question-container" class="mb-6 min-h-[150px] flex items-center justify-center">
                <p id="question-text" class="text-lg sm:text-xl text-gray-700 leading-relaxed text-center"></p>
                <div id="loader" class="loader hidden"></div>
            </div>
            <div id="feedback" class="mt-4 p-4 rounded-lg text-sm hidden"></div>
            
            <!-- Botões de Navegação -->
            <div id="navigation-container" class="flex flex-col sm:flex-row gap-4 items-center justify-between">
                <button id="check-btn" class="btn w-full sm:w-auto px-6 py-2 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-opacity-75 transition-transform transform hover:scale-105">Verificar</button>
                <button id="next-btn" class="btn hidden w-full sm:w-auto px-6 py-2 bg-green-500 text-white font-semibold rounded-lg shadow-md hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-opacity-75 transition-transform transform hover:scale-105">Próxima</button>
                <button id="gemini-generate-btn" class="gemini-btn btn hidden w-full sm:w-auto px-6 py-2 bg-purple-600 text-white font-semibold rounded-lg shadow-md hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-opacity-75 transition-transform transform hover:scale-105">✨ Gerar Nova Frase</button>
            </div>

            <!-- Tela de Resultados -->
            <div id="results-container" class="hidden text-center">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">Quiz Concluído!</h2>
                <p class="text-lg text-gray-700 mb-2">Sua pontuação final é:</p>
                <p id="score" class="text-4xl font-bold text-indigo-600 mb-6"></p>
                <button id="restart-btn" class="btn px-8 py-3 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-opacity-75 transition-transform transform hover:scale-105">Refazer Quiz</button>
            </div>
        </div>
    </div>

    <script src="js/main.js"></script>
    <script type="module" src="js/firebase-config.js"></script>
    <script type="module" src="js/header.js"></script>
    <script>
        // --- DADOS E VARIÁVEIS GLOBAIS ---
        const staticQuizData = [
            { question: "I can't find my keys. ⇒ I can't find&nbsp;{input}.", answers: ["them"], explanation: "<strong>Keys</strong> é plural. Para coisas, usamos <strong>it/it</strong> no singular e <strong>they/them</strong> no plural. Keys = they/them." },
            { question: "Rachel helps the students. ⇒&nbsp;{input}&nbsp;helps&nbsp;{input}.", answers: ["she", "them"], explanation: "Usamos pronomes sujeito (she) <strong>antes</strong> do verbo (helps). Usamos pronomes objeto (them) <strong>depois</strong> do verbo (helps)." },
            { question: "I need to tell John the truth. ⇒ I need to tell&nbsp;{input}&nbsp;the truth.", answers: ["him"], explanation: "John = he/him. Usamos pronomes objeto (him) <strong>depois</strong> do verbo (tell)." },
            { question: "My dad and I love chocolate. ⇒&nbsp;{input}&nbsp;love&nbsp;{input}.", answers: ["we", "it"], explanation: "Usamos pronomes sujeito (we) <strong>antes</strong> do verbo (love). Usamos pronomes objeto (it) <strong>depois</strong> do verbo (love). Chocolate = it." },
            { question: "Suzan and Tom call their daughter every day. ⇒&nbsp;{input}&nbsp;call&nbsp;{input}&nbsp;every day.", answers: ["they", "her"], explanation: "Suzan and Tom = they/them. Their daughter = she/her. Usamos pronomes sujeito (They) <strong>antes</strong> do verbo (call) e pronomes objeto (her) <strong>depois</strong> do verbo." },
            { question: "I like cooking for my children. ⇒ I like cooking for&nbsp;{input}.", answers: ["them"], explanation: "My children = they/them. Usamos pronomes objeto (them) <strong>depois</strong> de preposições (for)." },
            { question: "Give the documents to Carmen. ⇒ Give&nbsp;{input}&nbsp;to&nbsp;{input}.", answers: ["them", "her"], explanation: "Usamos pronomes objeto (them) <strong>depois</strong> do verbo (give) e (her) <strong>depois</strong> da preposição (to). <strong>Documents</strong> é plural, então usamos they/them." },
            { question: "Tom often plays football with my friends and me. ⇒&nbsp;{input}&nbsp;often plays football with&nbsp;{input}.", answers: ["he", "us"], explanation: "Tom = he/him. My friends and me = us. Usamos pronomes sujeito (He) <strong>antes</strong> do verbo (plays) e pronomes objeto (us) <strong>depois</strong> da preposição (with)." },
            { question: "How old is Emma? ⇒ How old is&nbsp;{input}?", answers: ["she"], explanation: "Emma = she/her. Precisamos de um pronome sujeito porque em perguntas, o sujeito vai <strong>depois</strong> do verbo 'be'." },
            { question: "I need the scissors to cut the paper. ⇒ I need&nbsp;{input}&nbsp;to cut&nbsp;{input}.", answers: ["them", "it"], explanation: "<strong>Scissors</strong> é plural (they/them). <strong>Paper</strong> é singular (it). Usamos pronomes objeto <strong>depois</strong> dos verbos (need, cut)." }
        ];
        
        let currentQuizData = [];
        let currentQuestionIndex = 0;
        let score = 0;
        let quizMode = ''; // 'standard' ou 'gemini'
        let currentDynamicQuestion = null;

        // --- ELEMENTOS DO DOM ---
        const welcomeScreenEl = document.getElementById('welcome-screen');
        const startQuizBtn = document.getElementById('start-quiz-btn');
        const modeSelectionEl = document.getElementById('mode-selection');
        const quizStructureEl = document.getElementById('quiz-structure');
        const standardQuizBtn = document.getElementById('standard-quiz-btn');
        const geminiPracticeBtn = document.getElementById('gemini-practice-btn');
        const backToMenuBtn = document.getElementById('back-to-menu');
        const quizTitleEl = document.getElementById('quiz-title');
        const headerContainer = document.getElementById('header-container');
        const progressContainer = document.getElementById('progress-container');
        const questionContainer = document.getElementById('question-container');
        const navigationContainer = document.getElementById('navigation-container');
        const questionTextEl = document.getElementById('question-text');
        const feedbackEl = document.getElementById('feedback');
        const checkBtn = document.getElementById('check-btn');
        const nextBtn = document.getElementById('next-btn');
        const geminiGenerateBtn = document.getElementById('gemini-generate-btn');
        const restartBtn = document.getElementById('restart-btn');
        const progressBar = document.getElementById('progress-bar');
        const progressText = document.getElementById('progress-text');
        const resultsContainer = document.getElementById('results-container');
        const scoreEl = document.getElementById('score');
        const loader = document.getElementById('loader');

        // --- LÓGICA DO QUIZ ---
        function startQuiz(mode) {
            quizMode = mode;
            currentQuestionIndex = 0;
            score = 0;
            modeSelectionEl.classList.add('hidden');
            quizStructureEl.classList.remove('hidden');
            
            headerContainer.classList.remove('hidden');
            navigationContainer.classList.remove('hidden');
            questionContainer.classList.remove('hidden');
            resultsContainer.classList.add('hidden');
            
            if (mode === 'standard') {
                quizTitleEl.textContent = 'Quiz Padrão';
                currentQuizData = [...staticQuizData];
                progressContainer.classList.remove('hidden');
                geminiGenerateBtn.classList.add('hidden');
                nextBtn.classList.remove('hidden');
                loadQuestion();
            } else if (mode === 'gemini') {
                quizTitleEl.textContent = 'Prática com IA';
                progressContainer.classList.add('hidden');
                checkBtn.classList.remove('hidden');
                nextBtn.classList.add('hidden');
                geminiGenerateBtn.classList.remove('hidden');
                generateNewGeminiQuestion();
            }
        }

        function loadQuestion() {
            resetQuestionUI();
            const questionData = currentQuizData[currentQuestionIndex];
            displayQuestion(questionData);
            updateProgress();
        }

        function displayQuestion(questionData) {
            let questionHTML = questionData.question;
            const inputsCount = (questionHTML.match(/{input}/g) || []).length;
            for (let i = 0; i < inputsCount; i++) {
                questionHTML = questionHTML.replace('{input}', `<input type="text" id="answer${i}" class="input-blank" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">`);
            }
            questionTextEl.innerHTML = questionHTML;
            document.getElementById('answer0')?.focus();
        }

        function resetQuestionUI() {
            feedbackEl.classList.add('hidden');
            checkBtn.classList.remove('hidden');
            checkBtn.disabled = false;
            nextBtn.classList.add('hidden');
            questionTextEl.classList.remove('hidden');
            loader.classList.add('hidden');
        }

        function updateProgress() {
            progressText.innerText = `Questão ${currentQuestionIndex + 1} de ${currentQuizData.length}`;
            const progressPercentage = ((currentQuestionIndex + 1) / currentQuizData.length) * 100;
            progressBar.style.width = `${progressPercentage}%`;
        }

        function checkAnswer() {
            const questionData = (quizMode === 'standard') ? currentQuizData[currentQuestionIndex] : currentDynamicQuestion;
            if (!questionData) return;

            let isCorrect = true;
            for (let i = 0; i < questionData.answers.length; i++) {
                const inputEl = document.getElementById(`answer${i}`);
                if (!inputEl) continue;
                const userAnswer = inputEl.value.trim().toLowerCase();
                const correctAnswer = questionData.answers[i].toLowerCase();
                
                if (userAnswer === correctAnswer) {
                    inputEl.style.borderColor = '#22c55e';
                } else {
                    inputEl.style.borderColor = '#ef4444';
                    isCorrect = false;
                }
                inputEl.disabled = true;
            }

            if (isCorrect) {
                score++;
                feedbackEl.classList.remove('bg-red-100', 'text-red-700');
                feedbackEl.classList.add('bg-green-100', 'text-green-700');
                feedbackEl.innerHTML = `<strong>Correto!</strong><br>${questionData.explanation}`;
            } else {
                feedbackEl.classList.remove('bg-green-100', 'text-green-700');
                feedbackEl.classList.add('bg-red-100', 'text-red-700');
                const correctAnswersText = questionData.answers.join(' / ');
                feedbackEl.innerHTML = `<strong>Incorreto.</strong> Resposta correta: <strong>${correctAnswersText}</strong><br>${questionData.explanation}`;
            }

            feedbackEl.classList.remove('hidden');
            checkBtn.classList.add('hidden');
            if (quizMode === 'standard') {
                nextBtn.classList.remove('hidden');
                if (currentQuestionIndex === currentQuizData.length - 1) {
                    nextBtn.textContent = 'Ver Resultados';
                } else {
                    nextBtn.textContent = 'Próxima';
                }
                nextBtn.focus();
            } else {
                geminiGenerateBtn.classList.remove('hidden');
                geminiGenerateBtn.focus();
            }
        }

        function showResults() {
            headerContainer.classList.add('hidden');
            progressContainer.classList.add('hidden');
            questionContainer.classList.add('hidden');
            navigationContainer.classList.add('hidden');
            
            resultsContainer.classList.remove('hidden');
            scoreEl.innerText = `${score} / ${currentQuizData.length}`;
        }
        
        function backToMenu() {
            quizStructureEl.classList.add('hidden');
            modeSelectionEl.classList.remove('hidden');
        }

        // --- LÓGICA DA API GEMINI ---
        async function generateNewGeminiQuestion() {
            resetQuestionUI();
            questionTextEl.classList.add('hidden');
            loader.classList.remove('hidden');
            checkBtn.disabled = true;
            geminiGenerateBtn.disabled = true;

            const prompt = `Crie uma questão de quiz em inglês para testar o conhecimento sobre pronomes de sujeito (subject pronouns) e objeto (object pronouns). A frase deve ter um ou dois espaços em branco, representados por "{input}". Forneça a resposta correta e uma explicação concisa em português. A explicação deve ser simples e direta. Retorne o resultado num formato JSON. Exemplo de frase: "Sarah gave {input} a book, and {input} loved it."`;

            const schema = {
                type: "OBJECT",
                properties: {
                    question: { type: "STRING" },
                    answers: { type: "ARRAY", items: { type: "STRING" } },
                    explanation: { type: "STRING" }
                },
                required: ["question", "answers", "explanation"]
            };

            try {
                const result = await callGemini(prompt, schema);
                currentDynamicQuestion = result;
                displayQuestion(result);
            } catch (error) {
                console.error("Error calling Gemini API:", error);
                questionTextEl.innerHTML = "Ocorreu um erro ao gerar a questão. Por favor, tente novamente.";
            } finally {
                questionTextEl.classList.remove('hidden');
                loader.classList.add('hidden');
                checkBtn.disabled = false;
                geminiGenerateBtn.disabled = false;
            }
        }
        
        async function callGemini(prompt, schema) {
            const apiKey = "AIzaSyAfTvpDGULlQo72Xkv_1JW1W7cjQ6K_9ts"; // A chave será fornecida pelo ambiente
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            
            const payload = {
                contents: [{ role: "user", parts: [{ text: prompt }] }],
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: schema,
                    temperature: 1.0,
                }
            };
            
            let response;
            let retries = 3;
            let delay = 1000;
            while (retries > 0) {
                try {
                    response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        const result = await response.json();
                        if (result.candidates && result.candidates[0].content && result.candidates[0].content.parts[0]) {
                            return JSON.parse(result.candidates[0].content.parts[0].text);
                        }
                    }
                } catch (error) {
                    console.log(`Retrying... attempts left: ${retries - 1}`);
                }
                retries--;
                await new Promise(res => setTimeout(res, delay));
                delay *= 2;
            }
            throw new Error("Falha ao comunicar com a API da Gemini após várias tentativas.");
        }


        // --- EVENT LISTENERS ---
        startQuizBtn.addEventListener('click', () => {
            welcomeScreenEl.classList.add('hidden');
            modeSelectionEl.classList.remove('hidden');
        });
        standardQuizBtn.addEventListener('click', () => startQuiz('standard'));
        geminiPracticeBtn.addEventListener('click', () => startQuiz('gemini'));
        backToMenuBtn.addEventListener('click', backToMenu);
        geminiGenerateBtn.addEventListener('click', generateNewGeminiQuestion);

        checkBtn.addEventListener('click', checkAnswer);
        
        nextBtn.addEventListener('click', () => {
            currentQuestionIndex++;
            if (currentQuestionIndex < currentQuizData.length) {
                loadQuestion();
            } else {
                showResults();
            }
        });

        restartBtn.addEventListener('click', () => {
            startQuiz('standard');
        });
        
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault(); 
                if (!checkBtn.classList.contains('hidden') && !checkBtn.disabled) {
                    checkBtn.click();
                } else if (!nextBtn.classList.contains('hidden')) {
                    nextBtn.click();
                }
            }
        });

    </script>
</body>
</html>
