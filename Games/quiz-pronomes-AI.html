<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Quiz de Pronomes com IA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Inter", sans-serif;
      }
      .quiz-container {
        max-width: 600px;
        width: 95%;
      }
      .input-blank {
        border-bottom: 2px solid #9ca3af;
        background-color: transparent;
        text-align: center;
        width: 80px;
        margin: 0 8px;
        padding: 2px 4px;
        font-weight: 600;
        color: #4f46e5;
        transition: all 0.3s ease;
      }
      .input-blank:focus {
        outline: none;
        border-bottom-color: #4f46e5;
      }
      /* Estilo para o spinner de carregamento */
      .loader {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #4f46e5;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
    </style>
  </head>
  <body class="bg-gray-100 flex items-center justify-center min-h-screen">
    <div
      id="quiz"
      class="quiz-container bg-white p-6 sm:p-8 rounded-xl shadow-lg"
    >
      <!-- Seleção de Modo -->
      <div id="mode-selection" class="text-center">
        <h1 class="text-2xl font-bold text-gray-800 mb-4">Quiz de Pronomes</h1>
        <p class="text-gray-600 mb-8">Escolha um modo para começar.</p>
        <div class="flex flex-col sm:flex-row gap-4">
          <button
            id="standard-quiz-btn"
            class="w-full px-6 py-3 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-opacity-75 transition-transform transform hover:scale-105"
          >
            Quiz Padrão (10 Questões)
          </button>
          <button
            id="gemini-practice-btn"
            class="w-full px-6 py-3 bg-purple-600 text-white font-semibold rounded-lg shadow-md hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-opacity-75 transition-transform transform hover:scale-105"
          >
            ✨ Prática com IA
          </button>
        </div>
      </div>

      <!-- Estrutura do Quiz (inicialmente escondida) -->
      <div id="quiz-structure" class="hidden">
        <!-- Header do Quiz -->
        <div
          id="header-container"
          class="flex justify-between items-center mb-6"
        >
          <h1
            id="quiz-title"
            class="text-xl sm:text-2xl font-bold text-gray-800"
          ></h1>
          <button
            id="back-to-menu"
            class="text-sm font-semibold text-indigo-600 hover:underline"
          >
            Menu
          </button>
        </div>

        <div id="progress-container">
          <div class="flex justify-between items-center mb-2">
            <span class="text-sm font-medium text-gray-700">Progresso</span>
            <span id="progress-text" class="text-sm font-semibold text-gray-600"
              >Questão 1 de 10</span
            >
          </div>
          <div class="w-full bg-gray-200 rounded-full h-2.5 mb-6">
            <div
              id="progress-bar"
              class="bg-indigo-600 h-2.5 rounded-full"
              style="width: 10%"
            ></div>
          </div>
        </div>

        <!-- Container da Questão -->
        <div
          id="question-container"
          class="mb-6 min-h-[150px] flex items-center justify-center"
        >
          <p
            id="question-text"
            class="text-lg sm:text-xl text-gray-700 leading-relaxed text-center"
          ></p>
          <div id="loader" class="loader hidden"></div>
        </div>
        <div id="feedback" class="mt-4 p-4 rounded-lg text-sm hidden"></div>

        <!-- Botões de Navegação -->
        <div
          id="navigation-container"
          class="flex flex-col sm:flex-row gap-4 items-center justify-between"
        >
          <button
            id="check-btn"
            class="w-full sm:w-auto px-6 py-2 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-opacity-75 transition-transform transform hover:scale-105"
          >
            Verificar
          </button>
          <button
            id="next-btn"
            class="hidden w-full sm:w-auto px-6 py-2 bg-green-500 text-white font-semibold rounded-lg shadow-md hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-opacity-75 transition-transform transform hover:scale-105"
          >
            Próxima
          </button>
          <button
            id="gemini-generate-btn"
            class="hidden w-full sm:w-auto px-6 py-2 bg-purple-600 text-white font-semibold rounded-lg shadow-md hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-opacity-75 transition-transform transform hover:scale-105"
          >
            ✨ Gerar Nova Frase
          </button>
        </div>

        <!-- Tela de Resultados -->
        <div id="results-container" class="hidden text-center">
          <h2 class="text-2xl font-bold text-gray-800 mb-4">Quiz Concluído!</h2>
          <p class="text-lg text-gray-700 mb-2">Sua pontuação final é:</p>
          <p id="score" class="text-4xl font-bold text-indigo-600 mb-6"></p>
          <button
            id="restart-btn"
            class="px-8 py-3 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-opacity-75 transition-transform transform hover:scale-105"
          >
            Refazer Quiz
          </button>
        </div>
      </div>
    </div>

    <script>
      // --- DADOS E VARIÁVEIS GLOBAIS ---
      const staticQuizData = [
        {
          question: "What time can I call&nbsp;{input}? ",
          inputs: 1,
          answers: ["him"],
          explanation:
            "Usamos pronomes objeto (me, you, him, her, it, us, them) <strong>depois</strong> de um verbo (call) ou preposição.",
        },
        {
          question: "{input}&nbsp;never listens to&nbsp;{input}.",
          inputs: 2,
          answers: ["he", "us"],
          explanation:
            "Usamos pronomes sujeito (I, you, he, she, it, we, they) <strong>antes</strong> do verbo (listens). Usamos pronomes objeto (me, you, him, her, it, us, them) <strong>depois</strong> do verbo ou de uma preposição (to us).",
        },
        {
          question:
            "'Do you like my new glasses?' 'Yes,&nbsp;{input}&nbsp;love&nbsp;{input}.'",
          inputs: 2,
          answers: ["i", "them"],
          explanation:
            "Usamos pronomes sujeito (I) <strong>antes</strong> do verbo (love). 'Glasses' é plural, então usamos o pronome objeto 'them'.",
        },
        {
          question:
            "Tom loves his rabbits.&nbsp;{input}&nbsp;plays with&nbsp;{input}&nbsp;in the garden every day.",
          inputs: 2,
          answers: ["he", "them"],
          explanation:
            "Usamos o pronome sujeito 'He' para se referir a Tom (antes do verbo 'plays'). Usamos o pronome objeto 'them' para se referir a 'rabbits' (depois da preposição 'with').",
        },
        {
          question:
            "Please, call&nbsp;{input}&nbsp;soon;&nbsp;{input}&nbsp;am very worried.",
          inputs: 2,
          answers: ["me", "i"],
          explanation:
            "Usamos o pronome objeto 'me' <strong>depois</strong> do verbo (call). Usamos o pronome sujeito 'I' <strong>antes</strong> do verbo (am).",
        },
        {
          question: "Look, Sara and Kevin. Can you see&nbsp;{input}?",
          inputs: 1,
          answers: ["them"],
          explanation:
            "Usamos o pronome objeto 'them' para se referir a 'Sara and Kevin' <strong>depois</strong> do verbo (see).",
        },
        {
          question:
            "Tell John that&nbsp;{input}&nbsp;can meet&nbsp;{input}&nbsp;at the canteen.",
          inputs: 2,
          answers: ["he", "us"],
          explanation:
            "Usamos o pronome sujeito 'he' (referindo-se a John) <strong>antes</strong> do verbo (can meet). Usamos o pronome objeto 'us' <strong>depois</strong> do verbo.",
        },
        {
          question:
            "I like your earrings. Can&nbsp;{input}&nbsp;see&nbsp;{input}?",
          inputs: 2,
          answers: ["i", "them"],
          explanation:
            "Usamos o pronome sujeito 'I' <strong>antes</strong> do verbo (see). 'Earrings' é plural, então usamos o pronome objeto 'them'.",
        },
        {
          question: "Look at that man. Who is&nbsp;{input}?",
          inputs: 1,
          answers: ["he"],
          explanation:
            "Precisamos de um pronome sujeito ('he') porque em perguntas com o verbo 'to be', o sujeito vem <strong>depois</strong> do verbo.",
        },
        {
          question: "That man over there is David. I work with&nbsp;{input}.",
          inputs: 1,
          answers: ["him"],
          explanation:
            "Usamos pronomes objeto ('him') <strong>depois</strong> de preposições (with).",
        },
      ];

      let currentQuizData = [];
      let currentQuestionIndex = 0;
      let score = 0;
      let quizMode = ""; // 'standard' ou 'gemini'
      let currentDynamicQuestion = null;

      // --- ELEMENTOS DO DOM ---
      const modeSelectionEl = document.getElementById("mode-selection");
      const quizStructureEl = document.getElementById("quiz-structure");
      const standardQuizBtn = document.getElementById("standard-quiz-btn");
      const geminiPracticeBtn = document.getElementById("gemini-practice-btn");
      const backToMenuBtn = document.getElementById("back-to-menu");
      const quizTitleEl = document.getElementById("quiz-title");
      const headerContainer = document.getElementById("header-container");
      const progressContainer = document.getElementById("progress-container");
      const questionContainer = document.getElementById("question-container");
      const navigationContainer = document.getElementById(
        "navigation-container"
      );
      const questionTextEl = document.getElementById("question-text");
      const feedbackEl = document.getElementById("feedback");
      const checkBtn = document.getElementById("check-btn");
      const nextBtn = document.getElementById("next-btn");
      const geminiGenerateBtn = document.getElementById("gemini-generate-btn");
      const restartBtn = document.getElementById("restart-btn");
      const progressBar = document.getElementById("progress-bar");
      const progressText = document.getElementById("progress-text");
      const resultsContainer = document.getElementById("results-container");
      const scoreEl = document.getElementById("score");
      const loader = document.getElementById("loader");

      // --- LÓGICA DO QUIZ ---
      function startQuiz(mode) {
        quizMode = mode;
        currentQuestionIndex = 0;
        score = 0;
        modeSelectionEl.classList.add("hidden");
        quizStructureEl.classList.remove("hidden");

        // Garante que os elementos corretos estão visíveis
        headerContainer.classList.remove("hidden");
        navigationContainer.classList.remove("hidden");
        questionContainer.classList.remove("hidden");
        resultsContainer.classList.add("hidden");

        if (mode === "standard") {
          quizTitleEl.textContent = "Quiz Padrão";
          currentQuizData = [...staticQuizData];
          progressContainer.classList.remove("hidden");
          geminiGenerateBtn.classList.add("hidden");
          nextBtn.classList.remove("hidden");
          loadQuestion();
        } else if (mode === "gemini") {
          quizTitleEl.textContent = "Prática com IA";
          progressContainer.classList.add("hidden");
          checkBtn.classList.remove("hidden");
          nextBtn.classList.add("hidden");
          geminiGenerateBtn.classList.remove("hidden");
          generateNewGeminiQuestion();
        }
      }

      function loadQuestion() {
        resetQuestionUI();
        const questionData = currentQuizData[currentQuestionIndex];
        displayQuestion(questionData);
        updateProgress();
      }

      function displayQuestion(questionData) {
        let questionHTML = questionData.question;
        const inputsCount = (questionHTML.match(/{input}/g) || []).length;
        for (let i = 0; i < inputsCount; i++) {
          questionHTML = questionHTML.replace(
            "{input}",
            `<input type="text" id="answer${i}" class="input-blank" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">`
          );
        }
        questionTextEl.innerHTML = questionHTML;
        document.getElementById("answer0")?.focus();
      }

      function resetQuestionUI() {
        feedbackEl.classList.add("hidden");
        checkBtn.classList.remove("hidden");
        checkBtn.disabled = false;
        nextBtn.classList.add("hidden");
        questionTextEl.classList.remove("hidden");
        loader.classList.add("hidden");
      }

      function updateProgress() {
        progressText.innerText = `Questão ${currentQuestionIndex + 1} de ${
          currentQuizData.length
        }`;
        const progressPercentage =
          ((currentQuestionIndex + 1) / currentQuizData.length) * 100;
        progressBar.style.width = `${progressPercentage}%`;
      }

      function checkAnswer() {
        const questionData =
          quizMode === "standard"
            ? currentQuizData[currentQuestionIndex]
            : currentDynamicQuestion;
        if (!questionData) return;

        let isCorrect = true;
        for (let i = 0; i < questionData.answers.length; i++) {
          const inputEl = document.getElementById(`answer${i}`);
          if (!inputEl) continue;
          const userAnswer = inputEl.value.trim().toLowerCase();
          const correctAnswer = questionData.answers[i].toLowerCase();

          if (userAnswer === correctAnswer) {
            inputEl.style.borderColor = "#22c55e";
          } else {
            inputEl.style.borderColor = "#ef4444";
            isCorrect = false;
          }
          inputEl.disabled = true;
        }

        if (isCorrect) {
          score++;
          feedbackEl.classList.remove("bg-red-100", "text-red-700");
          feedbackEl.classList.add("bg-green-100", "text-green-700");
          feedbackEl.innerHTML = `<strong>Correto!</strong><br>${questionData.explanation}`;
        } else {
          feedbackEl.classList.remove("bg-green-100", "text-green-700");
          feedbackEl.classList.add("bg-red-100", "text-red-700");
          const correctAnswersText = questionData.answers.join(" / ");
          feedbackEl.innerHTML = `<strong>Incorreto.</strong> Resposta correta: <strong>${correctAnswersText}</strong><br>${questionData.explanation}`;
        }

        feedbackEl.classList.remove("hidden");
        checkBtn.classList.add("hidden");
        if (quizMode === "standard") {
          nextBtn.classList.remove("hidden");
          nextBtn.focus();
        } else {
          geminiGenerateBtn.classList.remove("hidden");
          geminiGenerateBtn.focus();
        }
      }

      function showResults() {
        // Esconde os elementos do quiz, mas não o contentor principal
        headerContainer.classList.add("hidden");
        progressContainer.classList.add("hidden");
        questionContainer.classList.add("hidden");
        navigationContainer.classList.add("hidden");

        // Mostra o contentor de resultados
        resultsContainer.classList.remove("hidden");
        scoreEl.innerText = `${score} / ${currentQuizData.length}`;
      }

      function backToMenu() {
        quizStructureEl.classList.add("hidden");
        modeSelectionEl.classList.remove("hidden");
      }

      // --- LÓGICA DA API GEMINI ---
      async function generateNewGeminiQuestion() {
        resetQuestionUI();
        questionTextEl.classList.add("hidden");
        loader.classList.remove("hidden");
        checkBtn.disabled = true;
        geminiGenerateBtn.disabled = true;

        const prompt = `Crie uma questão de quiz em inglês para testar o conhecimento sobre pronomes de sujeito (subject pronouns) e objeto (object pronouns). A frase deve ter um ou dois espaços em branco, representados por "{input}". Forneça a resposta correta e uma explicação concisa em português. A explicação deve ser simples e direta. Retorne o resultado num formato JSON. Exemplo de frase: "Sarah gave {input} a book, and {input} loved it."`;

        const schema = {
          type: "OBJECT",
          properties: {
            question: { type: "STRING" },
            answers: { type: "ARRAY", items: { type: "STRING" } },
            explanation: { type: "STRING" },
          },
          required: ["question", "answers", "explanation"],
        };

        try {
          const result = await callGemini(prompt, schema);
          currentDynamicQuestion = result;
          displayQuestion(result);
        } catch (error) {
          console.error("Error calling Gemini API:", error);
          questionTextEl.innerHTML =
            "Ocorreu um erro ao gerar a questão. Por favor, tente novamente.";
        } finally {
          questionTextEl.classList.remove("hidden");
          loader.classList.add("hidden");
          checkBtn.disabled = false;
          geminiGenerateBtn.disabled = false;
        }
      }

      async function callGemini(prompt, schema) {
        const apiKey = "AIzaSyAfTvpDGULlQo72Xkv_1JW1W7cjQ6K_9ts"; // A chave será fornecida pelo ambiente
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

        const payload = {
          contents: [{ role: "user", parts: [{ text: prompt }] }],
          generationConfig: {
            responseMimeType: "application/json",
            responseSchema: schema,
            temperature: 1.0, // Aumenta a criatividade
          },
        };

        // Lógica de retentativa (Exponential Backoff)
        let response;
        let retries = 3;
        let delay = 1000;
        while (retries > 0) {
          try {
            response = await fetch(apiUrl, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(payload),
            });

            if (response.ok) {
              const result = await response.json();
              if (
                result.candidates &&
                result.candidates[0].content &&
                result.candidates[0].content.parts[0]
              ) {
                return JSON.parse(result.candidates[0].content.parts[0].text);
              }
            }
          } catch (error) {
            console.log(`Retrying... attempts left: ${retries - 1}`);
          }
          retries--;
          await new Promise((res) => setTimeout(res, delay));
          delay *= 2;
        }
        throw new Error(
          "Falha ao comunicar com a API da Gemini após várias tentativas."
        );
      }

      // --- EVENT LISTENERS ---
      standardQuizBtn.addEventListener("click", () => startQuiz("standard"));
      geminiPracticeBtn.addEventListener("click", () => startQuiz("gemini"));
      backToMenuBtn.addEventListener("click", backToMenu);
      geminiGenerateBtn.addEventListener("click", generateNewGeminiQuestion);

      checkBtn.addEventListener("click", checkAnswer);

      nextBtn.addEventListener("click", () => {
        currentQuestionIndex++;
        if (currentQuestionIndex < currentQuizData.length) {
          loadQuestion();
        } else {
          showResults();
        }
      });

      restartBtn.addEventListener("click", () => {
        startQuiz("standard");
      });

      document.addEventListener("keypress", function (e) {
        if (e.key === "Enter") {
          if (!checkBtn.classList.contains("hidden") && !checkBtn.disabled) {
            checkBtn.click();
          } else if (!nextBtn.classList.contains("hidden")) {
            nextBtn.click();
          }
        }
      });
    </script>
  </body>
</html>
