<!DOCTYPE html>
<html lang="pt" translate="no">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Language" content="en">
    <title>Pronoun Quiz: Drag and Drop</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .quiz-container {
            max-width: 700px;
            width: 95%;
            position: relative; /* Necess√°rio para posicionar o bot√£o do tema */
        }
        .drop-zone {
            display: inline-block;
            min-width: 90px;
            height: 40px;
            padding: 0 12px;
            margin: 0 8px;
            border: 2px dashed #9ca3af; /* gray-400 */
            border-radius: 8px;
            text-align: center;
            line-height: 36px;
            vertical-align: middle;
            font-weight: 600;
            transition: all 0.2s ease;
        }
        .drop-zone.filled {
            cursor: pointer;
        }
        .drag-over {
            transform: scale(1.05);
        }
        .option-card {
            padding: 8px 16px;
            border-radius: 8px;
            cursor: grab;
            user-select: none;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            transition: all 0.2s ease;
        }
        .option-card:hover {
            transform: translateY(-2px);
        }
        .dragging {
            opacity: 0.5;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            transform: scale(1.05);
        }
        .dropped {
            visibility: hidden;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
        }
        .modal-content {
            background-color: #fefefe;
            margin: 15% auto;
            padding: 20px;
            border-radius: 8px;
            width: 80%;
            max-width: 500px;
            position: relative;
        }
        .close-modal {
            color: #aaa;
            position: absolute;
            top: 10px;
            right: 20px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .explanation-text {
            white-space: pre-wrap; /* Para preservar quebras de linha da resposta da API */
        }
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-radius: 50%;
            border-top: 4px solid #3498db;
            width: 20px;
            height: 20px;
            -webkit-animation: spin 1s linear infinite;
            animation: spin 1s linear infinite;
        }
        @-webkit-keyframes spin {
            0% { -webkit-transform: rotate(0deg); }
            100% { -webkit-transform: rotate(360deg); }
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Estilos do Dark Mode */
        html.dark {
            background-color: #1a202c; /* gray-900 */
        }
        html.dark .quiz-container {
            background-color: #2d3748; /* gray-800 */
        }
        html.dark h1, html.dark h2, html.dark p, html.dark table {
            color: #e2e8f0; /* gray-200 */
        }
        html.dark .bg-gray-100 {
            background-color: #2d3748;
        }
        html.dark .bg-white {
            background-color: #2d3748;
        }
        html.dark .bg-gray-50 {
            background-color: #1a202c;
        }
        html.dark .text-gray-900 {
            color: #e2e8f0;
        }
        html.dark .border-gray-200 {
            border-color: #4a5568;
        }
        html.dark .border-gray-300 {
            border-color: #4a5568;
        }
        html.dark .text-gray-700 {
            color: #cbd5e0;
        }
        html.dark .text-gray-800 {
            color: #e2e8f0;
        }
        html.dark .text-gray-600 {
            color: #a0aec0;
        }
        html.dark .text-gray-400 {
             color: #a0aec0;
        }
        html.dark .option-card {
            background-color: #4a5568;
            border-color: #4a5568;
            color: #e2e8f0;
        }
        html.dark .drop-zone {
            background-color: #1a202c;
            border-color: #4a5568;
            color: #63b3ed;
        }
        html.dark .bg-indigo-100 {
            background-color: #4c51bf;
        }
        html.dark .text-indigo-800 {
            color: #e0e7ff;
        }
        html.dark .bg-gray-200 {
            background-color: #4a5568;
        }
        html.dark .modal-content {
            background-color: #1a202c;
            color: #e2e8f0;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen py-8 transition-colors duration-300" translate="no">

    <div id="quiz" class="quiz-container bg-white p-6 sm:p-8 rounded-xl shadow-lg transition-colors duration-300">
        <!-- Nova Tela de Introdu√ß√£o -->
        <div id="intro-screen" class="relative">
            <!-- Bot√£o de altern√¢ncia do tema na tela de introdu√ß√£o -->
            <button id="theme-toggle" class="absolute top-4 right-4 p-2 rounded-full text-gray-500 hover:bg-gray-200 dark:hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                 <!-- √çcone de Sol (Modo Claro) -->
                 <svg id="theme-toggle-light-icon" class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-sun"><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="M4.93 4.93l1.41 1.41"/><path d="M17.66 17.66l1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="M4.93 19.07l1.41-1.41"/><path d="M17.66 6.34l1.41-1.41"/></svg>
                 <!-- √çcone de Lua (Modo Escuro) -->
                 <svg id="theme-toggle-dark-icon" class="hidden w-6 h-6" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-moon"><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/></svg>
            </button>

            <div class="text-center mb-8">
                <h2 class="text-2xl font-bold text-gray-800 dark:text-gray-100 mb-4">Entendendo os Pronomes Objeto üéØ</h2>
                <p class="text-lg text-gray-700 dark:text-gray-200 mb-4">
                    Ol√°! Para come√ßar nosso quiz, vamos revisar rapidamente o que s√£o os **pronomes objeto** em ingl√™s.
                    Eles s√£o palavras pequenas que substituem nomes para evitar repeti√ß√£o nas frases.
                </p>
                <p class="text-lg text-gray-700 dark:text-gray-200 mb-6">
                    Lembre-se:
                    <br>‚û°Ô∏è **Pronomes Sujeito** s√£o aqueles que **fazem a a√ß√£o** na frase.
                    <br>‚û°Ô∏è **Pronomes Objeto** s√£o aqueles que **recebem a a√ß√£o** na frase.
                </p>
            </div>

            <div class="overflow-x-auto mb-8">
                <table class="min-w-full bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg shadow-sm">
                    <thead>
                        <tr class="bg-indigo-100 dark:bg-indigo-900 text-indigo-800 dark:text-indigo-200">
                            <th class="py-2 px-4 border-b border-gray-200 dark:border-gray-700 text-left">Pronome Sujeito</th>
                            <th class="py-2 px-4 border-b border-gray-200 dark:border-gray-700 text-left">Pronome Objeto</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td class="py-2 px-4 border-b border-gray-200 dark:border-gray-700 text-gray-700 dark:text-gray-200">I</td><td class="py-2 px-4 border-b border-gray-200 dark:border-gray-700 text-gray-700 dark:text-gray-200">me</td></tr>
                        <tr><td class="py-2 px-4 border-b border-gray-200 dark:border-gray-700 text-gray-700 dark:text-gray-200">you</td><td class="py-2 px-4 border-b border-gray-200 dark:border-gray-700 text-gray-700 dark:text-gray-200">you</td></tr>
                        <tr><td class="py-2 px-4 border-b border-gray-200 dark:border-gray-700 text-gray-700 dark:text-gray-200">he</td><td class="py-2 px-4 border-b border-gray-200 dark:border-gray-700 text-gray-700 dark:text-gray-200">him</td></tr>
                        <tr><td class="py-2 px-4 border-b border-gray-200 dark:border-gray-700 text-gray-700 dark:text-gray-200">she</td><td class="py-2 px-4 border-b border-gray-200 dark:border-gray-700 text-gray-700 dark:text-gray-200">her</td></tr>
                        <tr><td class="py-2 px-4 border-b border-gray-200 dark:border-gray-700 text-gray-700 dark:text-gray-200">it</td><td class="py-2 px-4 border-b border-gray-200 dark:border-gray-700 text-gray-700 dark:text-gray-200">it</td></tr>
                        <tr><td class="py-2 px-4 border-b border-gray-200 dark:border-gray-700 text-gray-700 dark:text-gray-200">we</td><td class="py-2 px-4 border-b border-gray-200 dark:border-gray-700 text-gray-700 dark:text-gray-200">us</td></tr>
                        <tr><td class="py-2 px-4 border-b border-gray-200 dark:border-gray-700 text-gray-700 dark:text-gray-200">you</td><td class="py-2 px-4 border-b border-gray-200 dark:border-gray-700 text-gray-700 dark:text-gray-200">you</td></tr>
                        <tr><td class="py-2 px-4 border-b border-gray-200 dark:border-gray-700 text-gray-700 dark:text-gray-200">they</td><td class="py-2 px-4 border-b border-gray-200 dark:border-gray-700 text-gray-700 dark:text-gray-200">them</td></tr>
                    </tbody>
                </table>
            </div>

            <div class="text-center">
                <button id="start-quiz-btn" class="px-8 py-3 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-opacity-75 transition-transform transform hover:scale-105">
                    Come√ßar o Quiz!
                </button>
            </div>
        </div>

        <!-- Conte√∫do do Quiz (inicialmente oculto) -->
        <div id="quiz-game-container" class="hidden">
            <!-- Header do Quiz -->
            <div id="header-container">
                <div class="flex justify-between items-center mb-6">
                    <h1 class="text-xl sm:text-2xl font-bold text-gray-800 dark:text-gray-100">Pronoun Quiz</h1>
                    <div class="flex items-center gap-4">
                        <div id="progress-text" class="text-sm font-semibold text-gray-600 dark:text-gray-400">Question 1 of 10</div>
                    </div>
                </div>
                
                <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2.5 mb-6">
                    <div id="progress-bar" class="bg-indigo-600 h-2.5 rounded-full" style="width: 10%"></div>
                </div>
            </div>

            <!-- Container da Quest√£o -->
            <div id="question-container" class="mb-6">
                <div class="flex justify-center items-center gap-2 mb-8">
                    <button id="play-audio-btn" class="p-2 rounded-full text-indigo-600 hover:bg-gray-200 dark:hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-indigo-500" title="Ler em voz alta">
                         <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-volume-2"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M15.54 8.46a5 5 0 0 1 0 7.07"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14"/></svg>
                    </button>
                    <p id="question-text" class="text-lg sm:text-xl text-gray-700 dark:text-gray-200 leading-loose text-center"></p>
                </div>
                <div id="options-container" class="flex flex-wrap justify-center items-center gap-3 p-4 bg-gray-50 dark:bg-gray-900 rounded-lg min-h-[60px]"></div>
                <div id="feedback" class="mt-4 p-4 rounded-lg text-sm hidden"></div>
            </div>
            
            <!-- Bot√µes de Navega√ß√£o -->
            <div id="navigation-container" class="flex flex-col sm:flex-row justify-center sm:justify-end items-center mt-6 gap-4 sm:gap-2">
                <button id="check-btn" class="w-full sm:w-auto px-6 py-3 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-opacity-75 transition-transform transform hover:scale-105 disabled:bg-gray-400 disabled:cursor-not-allowed disabled:transform-none">Check</button>
                <button id="explain-btn" class="w-full sm:w-auto px-6 py-3 bg-indigo-500 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-600 focus:outline-none focus:ring-2 focus:ring-indigo-400 focus:ring-opacity-75 transition-transform transform hover:scale-105 hidden">
                    Explicar meu erro ‚ú®
                </button>
                <button id="next-btn" class="hidden w-full sm:w-auto px-6 py-3 bg-green-500 text-white font-semibold rounded-lg shadow-md hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-opacity-75 transition-transform transform hover:scale-105">Pr√≥ximo</button>
            </div>

            <!-- Tela de Resultados -->
            <div id="results-container" class="hidden text-center py-8">
                <h2 class="text-2xl font-bold text-gray-800 dark:text-gray-100 mb-4">Quiz Conclu√≠do!</h2>
                <p class="text-lg text-gray-700 dark:text-gray-200 mb-2">Sua pontua√ß√£o final √©:</p>
                <p id="score" class="text-4xl font-bold text-indigo-600 dark:text-indigo-400 mb-6"></p>
                <button id="restart-btn" class="px-8 py-3 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-opacity-75 transition-transform transform hover:scale-105">Refazer o Quiz</button>
            </div>
        </div>
    </div>

    <!-- Modal para a explica√ß√£o -->
    <div id="explanation-modal" class="modal">
        <div class="modal-content dark:bg-gray-800">
            <span class="close-modal">&times;</span>
            <h3 class="text-xl font-bold mb-4">Explica√ß√£o da Resposta</h3>
            <p id="explanation-text" class="explanation-text text-gray-700 dark:text-gray-200"></p>
        </div>
    </div>

    <script>
        // Dicion√°rio de tradu√ß√µes para palavras-chave e pronomes
        const translations = {
            // Pronoun translations
            "I": "eu",
            "me": "me / mim",
            "you": "voc√™ / voc√™s",
            "he": "ele",
            "him": "o / ele",
            "she": "ela",
            "her": "a / ela",
            "it": "ele / ela (neutro)",
            "we": "n√≥s",
            "us": "nos / n√≥s",
            "they": "eles / elas",
            "them": "os / as / eles / elas",

            // Common word translations from stories
            "very": "muito",
            "is": "√© / est√°",
            "my": "meu / minha",
            "brother": "irm√£o",
            "when": "quando",
            "friend": "amigo / amiga",
            "showed": "mostrou",
            "glasses": "√≥culos",
            "asked": "perguntou",
            "great": "√≥timo",
            "with": "com",
            "mom": "m√£e",
            "sounded": "parecia",
            "upset": "chateado(a)",
            "said": "disse",
            "worried": "preocupado(a)",
            "about": "sobre",
            "are": "s√£o / est√£o",
            "concert": "show / concerto",
            "look": "olhe",
            "there": "l√°",
            "stage": "palco",
            "from": "de",
            "here": "aqui",
            "need": "precisar",
            "talk": "conversar",
            "meeting": "reuni√£o",
            "tell": "dizer / contar",
            "earrings": "brincos",
            "beautiful": "bonito(a)",
            "saw": "vimos / viu",
            "someone": "algu√©m",
            "across the street": "do outro lado da rua",
            "man": "homem",
            "Who": "Quem",
            "Do": "Voc√™", 
            "know": "conhece",
            "colleague": "colega",
            "That": "Aquele",
            "Mark": "Marcos",
            "busy": "ocupado",
            "today": "hoje",
            "What": "O que",
            "time": "hora",
            "can": "pode",
            "call": "ligar",
            "discuss": "discutir",
            "project": "projeto",
            "stubborn": "teimoso",
            "sometimes": "√†s vezes",
            "never": "nunca",
            "listens": "escuta",
            "try": "tentar",
            "give": "dar",
            "advice": "conselho",
            "on": "em",
            "Tom": "nome dele √© Tom",
            "has": "tem",
            "two": "dois",
            "pet": "de estima√ß√£o",
            "rabbits": "coelhos",
            "loves": "adora",
            "play": "brincar",
            "garden": "jardim",
            "every": "todo/a",
            "afternoon": " tarde",
            "Please": "Por favor",
            "soon": "em breve",
            "am": "estou",
            "or": "ou",
            "too": "muito",
            "far": "longe",
            "canteen": "cantina",
            "after": "depois",
            "class": "aula",
            "Your": "Seus",
            "really": "realmente",
            "like": "gosto",
            "up": "de",
            "close": "perto",
            "David": "nome dele √© David",
            "work": "trabalho",
            "marketing": "marketing",
            "team": "equipe",
            "She": "Ela",
            "her": "a / ela",
            "give": "dar",
            "him": "ele / o",
            "new": "novo",
            "phone": "telefone"
        };

        // Fun√ß√£o para adicionar tradu√ß√µes ao texto da hist√≥ria
        function addHoverTranslationsToText(text) {
            // Divide o texto pelo placeholder {dropzone} para processar as partes separadamente
            const parts = text.split('{dropzone}');
            let processedText = '';

            parts.forEach((part, index) => {
                let currentPart = part;
                // Processa cada parte para tradu√ß√µes de palavras
                for (const word in translations) {
                    // Cria uma regex para a palavra, garantindo que seja uma palavra inteira (\b)
                    // e que seja case-insensitive (gi)
                    // Esta regex evita substituir dentro de tags HTML j√° existentes (como &nbsp;)
                    const regex = new RegExp(`\\b${word}\\b(?!([^<]*>|[^>]*<))`, 'gi');
                    currentPart = currentPart.replace(regex, (match) => {
                        // Retorna a palavra original envolvida por um span com o t√≠tulo de tradu√ß√£o
                        return `<span title="${translations[word]}">${match}</span>`;
                    });
                }
                processedText += currentPart;
                // Adiciona de volta o placeholder {dropzone} se n√£o for a √∫ltima parte
                if (index < parts.length - 1) {
                    processedText += '{dropzone}';
                }
            });
            return processedText;
        }

        // Dados do quiz
        const quizData = [
            {
                story: "Mark is very busy today. What time can {dropzone} call&nbsp;{dropzone} to discuss {dropzone} project?",
                inputs: 3,
                answers: ["I", "him", "my"],
                options: ["I", "him", "her", "my"]
            },
            {
                story: "My brother can be stubborn sometimes. {dropzone} never listens to&nbsp{dropzone} when we try to give advice.",
                inputs: 2,
                answers: ["He", "us"],
                options: ["He", "Him", "we", "us"]
            },
            {
                story: "My friend showed me her new glasses. 'Do you like my new glasses?' she asked. 'Yes, {dropzone} love {dropzone}. They look great on you!'",
                inputs: 2,
                answers: ["I", "them"],
                options: ["I", "me", "they", "them"]
            },
            {
                story: "Tom has two pet rabbits. {dropzone} loves to play with {dropzone} in the garden every afternoon.",
                inputs: 2,
                answers: ["He", "them"],
                options: ["He", "Him", "they", "them"]
            },
            {
                story: "My mom sounded upset on the phone. She said: 'Please, call&nbsp{dropzone} soon; {dropzone} am very worried about you.'",
                inputs: 2,
                answers: ["me", "I"],
                options: ["I", "me", "my", "mine"]
            },
            {
                story: "We are at the concert. Look, Sara and Kevin are over there by the stage. Can {dropzone} see&nbsp{dropzone} from here, or are {dropzone} too far?",
                inputs: 3,
                answers: ["you", "them", "they"],
                options: ["you", "them", "they", "us"]
            },
            {
                story: "I need to talk to John about the meeting. Tell John that&nbsp{dropzone} can meet {dropzone} at the canteen after class.",
                inputs: 2,
                answers: ["we", "him"],
                options: ["he", "him", "we", "us"]
            },
            {
                story: "Your new earrings are beautiful! I really like {dropzone}. Can&nbsp{dropzone} see&nbsp{dropzone} up close?",
                inputs: 3,
                answers: ["them", "I", "them"],
                options: ["I", "me", "they", "them", "them"]
            },
            {
                story: "We saw someone familiar across the street. Look at that man. Who is&nbsp{dropzone}? Do {dropzone} know {dropzone}?",
                inputs: 3,
                answers: ["he", "you", "him"],
                options: ["he", "him", "you", "it"]
            },
            {
                story: "Do you know the new colleague? That man over there is David. {dropzone} work with&nbsp{dropzone} on the marketing team.",
                inputs: 2,
                answers: ["I", "him"],
                options: ["I", "he", "him", "me"]
            },
            {
                story: "I need to talk to my sister. Can you give {dropzone} her new phone number?",
                inputs: 1,
                answers: ["me"],
                options: ["me", "I", "my", "her"]
            }
        ];

        let currentQuestion = 0;
        let score = 0;
        let draggedItem = null;

        const questionTextEl = document.getElementById('question-text');
        const optionsContainer = document.getElementById('options-container');
        const feedbackEl = document.getElementById('feedback');
        const checkBtn = document.getElementById('check-btn');
        const nextBtn = document.getElementById('next-btn');
        const explainBtn = document.getElementById('explain-btn'); // New
        const restartBtn = document.getElementById('restart-btn');
        const progressBar = document.getElementById('progress-bar');
        const progressText = document.getElementById('progress-text');
        const resultsContainer = document.getElementById('results-container');
        const questionContainer = document.getElementById('question-container');
        const scoreEl = document.getElementById('score');
        const headerContainer = document.getElementById('header-container');
        const navigationContainer = document.getElementById('navigation-container');
        const explanationModal = document.getElementById('explanation-modal'); // New
        const explanationText = document.getElementById('explanation-text'); // New
        const closeModalBtn = document.querySelector('.close-modal'); // New
        const playAudioBtn = document.getElementById('play-audio-btn'); // New

        // Refer√™ncias para a tela de introdu√ß√£o
        const introScreen = document.getElementById('intro-screen');
        const quizGameContainer = document.getElementById('quiz-game-container');
        const startQuizBtn = document.getElementById('start-quiz-btn');

        // Refer√™ncias para os elementos do tema
        const themeToggleBtn = document.getElementById('theme-toggle');
        const themeToggleLightIcon = document.getElementById('theme-toggle-light-icon');
        const themeToggleDarkIcon = document.getElementById('theme-toggle-dark-icon');
        const html = document.documentElement;

        // Fun√ß√£o para aplicar o tema (claro ou escuro)
        function applyTheme() {
            if (localStorage.getItem('theme') === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                html.classList.add('dark');
                themeToggleLightIcon.classList.remove('hidden');
                themeToggleDarkIcon.classList.add('hidden');
            } else {
                html.classList.remove('dark');
                themeToggleLightIcon.classList.add('hidden');
                themeToggleDarkIcon.classList.remove('hidden');
            }
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        function loadQuiz() {
            feedbackEl.classList.add('hidden');
            checkBtn.classList.remove('hidden');
            checkBtn.disabled = true;
            nextBtn.classList.add('hidden');
            explainBtn.classList.add('hidden'); // Oculta o bot√£o de explica√ß√£o
            optionsContainer.innerHTML = '';
            
            const currentQuizData = quizData[currentQuestion];
            
            // Processa a hist√≥ria para adicionar tradu√ß√µes ao passar o mouse
            let questionHTML = addHoverTranslationsToText(currentQuizData.story);
            for (let i = 0; i < currentQuizData.inputs; i++) {
                questionHTML = questionHTML.replace('{dropzone}', `<span class="drop-zone bg-gray-100 dark:bg-gray-900 border-gray-400 dark:border-gray-600 text-indigo-600 dark:text-indigo-400" data-index="${i}"></span>`);
            }
            questionTextEl.innerHTML = questionHTML;

            const options = [...currentQuizData.options];
            shuffleArray(options);
            options.forEach(optionText => {
                const optionEl = document.createElement('div');
                optionEl.textContent = optionText;
                optionEl.classList.add('option-card', 'bg-white', 'dark:bg-gray-700', 'border', 'border-gray-300', 'dark:border-gray-600', 'text-gray-900', 'dark:text-gray-100');
                optionEl.draggable = true;
                
                // Adiciona o atributo title com a tradu√ß√£o para os cart√µes de op√ß√£o
                if (translations[optionText]) {
                    optionEl.title = translations[optionText];
                }
                optionsContainer.appendChild(optionEl);
            });

            addDragAndDropListeners();
            updateProgress();
        }

        function addDragAndDropListeners() {
            const draggables = document.querySelectorAll('.option-card');
            const dropZones = document.querySelectorAll('.drop-zone');

            draggables.forEach(draggable => {
                draggable.addEventListener('dragstart', () => {
                    draggedItem = draggable;
                    setTimeout(() => {
                        if(draggedItem) draggable.classList.add('dragging');
                    }, 0);
                });

                draggable.addEventListener('dragend', () => {
                    if(draggedItem) {
                        draggedItem.classList.remove('dragging');
                    }
                    draggedItem = null;
                });
            });

            dropZones.forEach(zone => {
                zone.addEventListener('dragover', e => {
                    e.preventDefault();
                    zone.classList.add('drag-over', 'border-indigo-500');
                });

                zone.addEventListener('dragleave', () => {
                    zone.classList.remove('drag-over', 'border-indigo-500');
                });

                zone.addEventListener('drop', e => {
                    e.preventDefault();
                    zone.classList.remove('drag-over', 'border-indigo-500');
                    if (draggedItem && !zone.textContent) {
                        zone.textContent = draggedItem.textContent;
                        zone.classList.add('filled');
                        draggedItem.classList.add('dropped');
                        checkAllZonesFilled();
                    }
                });
                
                zone.addEventListener('click', () => {
                    if (zone.textContent && !nextBtn.classList.contains('hidden')) {
                        return;
                    }
                    if (zone.textContent) {
                        const droppedText = zone.textContent;
                        zone.textContent = '';
                        zone.classList.remove('filled');

                        const optionCards = document.querySelectorAll('.option-card');
                        const cardToReturn = Array.from(optionCards).find(card => card.textContent === droppedText && card.classList.contains('dropped'));
                        if (cardToReturn) {
                            cardToReturn.classList.remove('dropped');
                        }
                        
                        checkAllZonesFilled();
                    }
                });
            });
        }
        
        function checkAllZonesFilled() {
            const dropZones = document.querySelectorAll('.drop-zone');
            const allFilled = [...dropZones].every(zone => zone.textContent !== '');
            checkBtn.disabled = !allFilled;
        }

        function checkAnswer() {
            const currentQuizData = quizData[currentQuestion];
            const dropZones = document.querySelectorAll('.drop-zone');
            let isCorrect = true;

            document.querySelectorAll('.option-card').forEach(c => c.draggable = false);
            dropZones.forEach(z => z.style.cursor = 'default');

            const userAnswers = [];
            dropZones.forEach(zone => {
                const zoneIndex = parseInt(zone.dataset.index);
                const userAnswer = zone.textContent.trim();
                userAnswers.push(userAnswer);
                const correctAnswer = currentQuizData.answers[zoneIndex];
                
                if (userAnswer.toLowerCase() === correctAnswer.toLowerCase()) {
                    zone.style.borderColor = '#22c55e'; /* green-500 */
                    zone.style.backgroundColor = '#dcfce7'; /* green-100 */
                } else {
                    zone.style.borderColor = '#ef4444'; /* red-500 */
                    zone.style.backgroundColor = '#fee2e2'; /* red-100 */
                    isCorrect = false;
                }
            });

            if (isCorrect) {
                score++;
                feedbackEl.innerHTML = `<strong>Correto!</strong>`;
                feedbackEl.className = 'mt-4 p-4 rounded-lg text-sm bg-green-100 text-green-700 dark:bg-green-800 dark:text-green-200';
            } else {
                const correctAnswersText = currentQuizData.answers.join(' / ');
                feedbackEl.innerHTML = `<strong>Incorreto.</strong> Resposta correta: <strong>${correctAnswersText}</strong>`;
                feedbackEl.className = 'mt-4 p-4 rounded-lg text-sm bg-red-100 text-red-700 dark:bg-red-800 dark:text-red-200';
                explainBtn.classList.remove('hidden'); // Mostra o bot√£o de explica√ß√£o
            }
            
            feedbackEl.classList.remove('hidden');
            checkBtn.classList.add('hidden');
            nextBtn.classList.remove('hidden');
            nextBtn.focus();
        }

        function updateProgress() {
            progressText.innerText = `Quest√£o ${currentQuestion + 1} de ${quizData.length}`;
            const progressPercentage = ((currentQuestion + 1) / quizData.length) * 100;
            progressBar.style.width = `${progressPercentage}%`;
        }

        function showResults() {
            headerContainer.classList.add('hidden');
            questionContainer.classList.add('hidden');
            navigationContainer.classList.add('hidden');
            resultsContainer.classList.remove('hidden');
            scoreEl.innerText = `${score} / ${quizData.length}`;
        }

        // Gemini API calls
        async function getExplanation() {
            explanationModal.style.display = 'block';
            explanationText.innerHTML = '<div class="flex justify-center items-center"><div class="loading-spinner"></div></div>'; // Loading spinner

            const currentQuizData = quizData[currentQuestion];
            const dropZones = document.querySelectorAll('.drop-zone');
            const userAnswers = [...dropZones].map(z => z.textContent.trim());
            
            const prompt = `For an English pronoun quiz, I got the following question wrong:
            Question: "${currentQuizData.story.replace(/{dropzone}/g, '_____')}"
            My answer was: "${userAnswers.join(', ')}".
            The correct answer is: "${currentQuizData.answers.join(', ')}".
            Provide a simple, clear, and concise explanation in Portuguese of why the correct answer is correct, focusing on the grammar rules for subject, object, or possessive pronouns/adjectives. Keep it short and to the point.`;

            let chatHistory = [];
            chatHistory.push({ role: "user", parts: [{ text: prompt }] });
            const payload = { contents: chatHistory };
            const apiKey = "" 
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            try {
                let response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                let result = await response.json();

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const text = result.candidates[0].content.parts[0].text;
                    explanationText.innerText = text;
                } else {
                    explanationText.innerText = 'N√£o foi poss√≠vel obter uma explica√ß√£o. Por favor, tente novamente.';
                }
            } catch (error) {
                console.error('API Error:', error);
                explanationText.innerText = 'Ocorreu um erro ao buscar a explica√ß√£o. Por favor, tente novamente mais tarde.';
            }
        }
        
        async function playTTS() {
            const currentQuizData = quizData[currentQuestion];
            const textToSpeak = currentQuizData.story.replace(/{dropzone}/g, '_____');

            playAudioBtn.disabled = true;
            playAudioBtn.innerHTML = `<div class="loading-spinner"></div>`;

            let retries = 0;
            const maxRetries = 5;

            while (retries < maxRetries) {
                try {
                    const payload = {
                        contents: [{
                            parts: [{ text: textToSpeak }]
                        }],
                        generationConfig: {
                            responseModalities: ["AUDIO"],
                            speechConfig: {
                                voiceConfig: {
                                    prebuiltVoiceConfig: { voiceName: "Puck" }
                                }
                            }
                        },
                        model: "gemini-2.5-flash-preview-tts"
                    };
                    const apiKey = "";
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`;
                    
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.status === 429) { // Too Many Requests
                        retries++;
                        const delay = Math.pow(2, retries) * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                        continue;
                    }

                    const result = await response.json();
                    const audioData = result?.candidates?.[0]?.content?.parts?.[0]?.inlineData?.data;
                    const mimeType = result?.candidates?.[0]?.content?.parts?.[0]?.inlineData?.mimeType;

                    if (audioData && mimeType && mimeType.startsWith("audio/")) {
                        const sampleRate = parseInt(mimeType.match(/rate=(\d+)/)[1], 10);
                        const pcmData = base64ToArrayBuffer(audioData);
                        const pcm16 = new Int16Array(pcmData);
                        const wavBlob = pcmToWav(pcm16, sampleRate);
                        const audioUrl = URL.createObjectURL(wavBlob);
                        
                        const audio = new Audio(audioUrl);
                        audio.play();
                    } else {
                        console.error('Failed to get audio data from API response.');
                    }
                    break;

                } catch (error) {
                    console.error('TTS API Error:', error);
                    break;
                }
            }

            playAudioBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-volume-2"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M15.54 8.46a5 5 0 0 1 0 7.07"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14"/></svg>`;
            playAudioBtn.disabled = false;
        }

        // TTS helper functions
        function base64ToArrayBuffer(base64) {
            const binaryString = atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        }

        function pcmToWav(pcmData, sampleRate) {
            const numChannels = 1;
            const bytesPerSample = 2;
            const bitDepth = 16;
            const byteRate = sampleRate * numChannels * bytesPerSample;
            const blockAlign = numChannels * bytesPerSample;

            const dataLength = pcmData.length * bytesPerSample;
            const buffer = new ArrayBuffer(44 + dataLength);
            const view = new DataView(buffer);
            let offset = 0;

            // RIFF chunk descriptor
            writeString(view, offset, 'RIFF'); offset += 4;
            view.setUint32(offset, 36 + dataLength, true); offset += 4;
            writeString(view, offset, 'WAVE'); offset += 4;

            // fmt chunk
            writeString(view, offset, 'fmt '); offset += 4;
            view.setUint32(offset, 16, true); offset += 4; // Subchunk1Size
            view.setUint16(offset, 1, true); offset += 2; // AudioFormat (1 for PCM)
            view.setUint16(offset, numChannels, true); offset += 2;
            view.setUint32(offset, sampleRate, true); offset += 4;
            view.setUint32(offset, byteRate, true); offset += 4;
            view.setUint16(offset, blockAlign, true); offset += 2;
            view.setUint16(offset, bitDepth, true); offset += 2;

            // data chunk
            writeString(view, offset, 'data'); offset += 4;
            view.setUint32(offset, dataLength, true); offset += 4;

            // Write PCM data
            for (let i = 0; i < pcmData.length; i++, offset += bytesPerSample) {
                view.setInt16(offset, pcmData[i], true);
            }

            return new Blob([view], { type: 'audio/wav' });
        }

        function writeString(view, offset, string) {
            for (let i = 0; i < string.length; i++) {
                view.setUint8(offset + i, string.charCodeAt(i));
            }
        }

        // Event listeners
        checkBtn.addEventListener('click', checkAnswer);
        nextBtn.addEventListener('click', () => {
            currentQuestion++;
            if (currentQuestion < quizData.length) {
                loadQuiz();
            } else {
                showResults();
            }
        });
        restartBtn.addEventListener('click', () => {
            currentQuestion = 0;
            score = 0;
            resultsContainer.classList.add('hidden');
            headerContainer.classList.remove('hidden');
            questionContainer.classList.remove('hidden');
            navigationContainer.classList.remove('hidden');
            loadQuiz();
        });

        startQuizBtn.addEventListener('click', () => {
            introScreen.classList.add('hidden'); // Esconde a tela de introdu√ß√£o
            quizGameContainer.classList.remove('hidden'); // Mostra o container do quiz
            loadQuiz(); // Carrega a primeira quest√£o do quiz
        });

        themeToggleBtn.addEventListener('click', () => {
            if (html.classList.contains('dark')) {
                html.classList.remove('dark');
                localStorage.setItem('theme', 'light');
            } else {
                html.classList.add('dark');
                localStorage.setItem('theme', 'dark');
            }
            applyTheme();
        });

        explainBtn.addEventListener('click', getExplanation); // New
        closeModalBtn.addEventListener('click', () => { // New
            explanationModal.style.display = 'none';
        });
        window.addEventListener('click', (event) => { // New
            if (event.target === explanationModal) {
                explanationModal.style.display = 'none';
            }
        });
        playAudioBtn.addEventListener('click', playTTS); // New

        applyTheme();
    </script>
</body>
</html>
