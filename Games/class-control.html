<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gestão de Alunos (Professor de Inglês)</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Supabase CDN -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap");
      body {
        font-family: "Inter", sans-serif;
        background-color: #f4f7f9;
      }
      /* Estilo para a barra lateral de alunos */
      #student-list-container {
        min-width: 280px;
        max-width: 300px;
      }
      /* Estilos de scrollbar customizados */
      .custom-scrollbar::-webkit-scrollbar {
        width: 8px;
      }
      .custom-scrollbar::-webkit-scrollbar-thumb {
        background-color: #a0aec0; /* gray-400 */
        border-radius: 4px;
      }
      .custom-scrollbar::-webkit-scrollbar-track {
        background-color: #edf2f7; /* gray-100 */
      }

      /* Estilo para destacar pagamentos não pagos */
      .unpaid-row {
        background-color: #fee2e2 !important; /* red-100 */
      }
      .unpaid-row:hover {
        background-color: #fecaca !important; /* red-200 */
      }
    </style>
  </head>
  <body class="min-h-screen">
    <div id="app" class="flex flex-col lg:flex-row min-h-screen">
      <!-- 1. Coluna de Alunos (Sidebar) -->
      <div
        id="student-list-container"
        class="bg-white border-r border-gray-200 p-4 shadow-lg flex flex-col h-full lg:h-screen sticky top-0 overflow-y-auto custom-scrollbar"
      >
        <h1 class="text-2xl font-bold text-indigo-700 mb-6 border-b pb-2">
          Meus Alunos
        </h1>

        <!-- Botão Adicionar Aluno -->
        <button
          onclick="window.openStudentModal()"
          class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-200 shadow-md mb-6 flex items-center justify-center"
        >
          <svg
            class="w-5 h-5 mr-2"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
            xmlns="http://www.w3.org/2000/svg"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"
            ></path>
          </svg>
          Novo Aluno
        </button>

        <!-- Lista de Alunos (Preenchida pelo JS) -->
        <div id="student-list" class="flex-grow space-y-2">
          <!-- Itens da lista de alunos serão injetados aqui -->
          <p class="text-gray-500 text-sm">Carregando alunos...</p>
        </div>

        <div class="mt-auto pt-4 border-t text-sm text-gray-500">
          <p>Seu ID de Usuário (para suporte):</p>
          <code
            id="user-id-display"
            class="block mt-1 font-mono text-xs text-indigo-600 truncate"
            >Autenticando...</code
          >
          <p id="supabase-status" class="mt-2 text-xs text-gray-500">
            (Status Supabase: Conectado)
          </p>
        </div>
      </div>

      <!-- 2. Detalhes do Aluno (Conteúdo Principal) -->
      <div id="student-details-view" class="flex-grow p-6 lg:p-10">
        <h2 id="main-title" class="text-3xl font-extrabold text-gray-800 mb-8">
          Selecione um Aluno
        </h2>

        <div
          id="student-details-content"
          class="bg-white p-6 rounded-xl shadow-2xl transition-all duration-300 transform opacity-0 scale-95 hidden"
        >
          <!-- Informações do Aluno (Fixo) -->
          <div class="flex justify-between items-center mb-6 border-b pb-3">
            <h3 class="text-xl font-semibold text-gray-700">
              Informações do Aluno
            </h3>
            <button
              onclick="window.openStudentModal(window.currentStudent)"
              class="text-sm text-indigo-500 hover:text-indigo-700 font-medium flex items-center"
            >
              <svg
                class="w-4 h-4 mr-1"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
                xmlns="http://www.w3.org/2000/svg"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-7-3l-4 4L19 7l4 4-4-4z"
                ></path>
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M15.5 5.5l3 3"
                ></path>
              </svg>
              Editar
            </button>
          </div>

          <div
            id="info-section"
            class="grid grid-cols-1 md:grid-cols-2 gap-4 text-gray-700 mb-8"
          >
            <!-- Dados do aluno serão injetados aqui -->
          </div>

          <!-- NOVO LAYOUT: Dropdown de Mês + Seções Filtradas -->
          <div class="lg:flex lg:space-x-8 mt-8">
            
            <!-- Dropdown de Meses (para filtro) - NOVO ELEMENTO -->
            <div
              id="month-dropdown-container"
              class="lg:w-1/4 mb-6 lg:mb-0 border p-3 rounded-xl bg-gray-50 self-start"
            >
              <label for="month-dropdown" class="text-lg font-bold text-indigo-700 mb-3 block border-b pb-2">
                Filtro Mensal
              </label>
              <select 
                id="month-dropdown" 
                onchange="window.selectMonth(this.value)"
                class="w-full mt-2 p-2 rounded-lg border border-gray-300 focus:ring-indigo-500 focus:border-indigo-500"
              >
                <!-- Opções de meses serão injetadas aqui por renderMonthTabs -->
              </select>
            </div>

            <!-- Conteúdo Filtrado -->
            <div class="lg:w-3/4">
              <!-- 1. Controle de Mensalidade (MOVIDO PARA CIMA) -->
              <div id="payments-section" class="mb-8 border-t pt-6">
                <div class="flex justify-between items-center mb-4">
                  <h3 class="text-xl font-semibold text-gray-700">
                    Controle de Mensalidade (Mês Selecionado)
                  </h3>
                  <button
                    onclick="window.openPaymentModal()"
                    class="bg-yellow-500 hover:bg-yellow-600 text-white text-sm font-semibold py-1 px-3 rounded transition duration-200 flex items-center"
                  >
                    <svg
                      class="w-4 h-4 mr-1"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                      xmlns="http://www.w3.org/2000/svg"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M12 4v16m8-8H4"
                      ></path>
                    </svg>
                    Novo Pagamento
                  </button>
                </div>

                <div class="overflow-x-auto rounded-lg shadow-inner">
                  <table class="min-w-full bg-gray-50">
                    <thead class="bg-indigo-500 text-white">
                      <tr>
                        <th class="py-2 px-4 text-left">Mês</th>
                        <th class="py-2 px-4 text-center">Pago?</th>
                        <th class="py-2 px-4 text-left">Dia Pago</th>
                        <th class="py-2 px-4">Ações</th>
                      </tr>
                    </thead>
                    <tbody id="payments-table-body">
                      <!-- Mensalidades serão injetadas aqui -->
                    </tbody>
                  </table>
                </div>
              </div>

              <!-- 2. Controle de Aulas (MOVIDO PARA BAIXO) -->
              <div id="classes-section" class="border-t pt-6">
                <div class="flex justify-between items-center mb-4">
                  <h3 class="text-xl font-semibold text-gray-700">
                    Controle de Aulas (Mês Selecionado)
                  </h3>
                  <button
                    onclick="window.openClassModal()"
                    class="bg-green-500 hover:bg-green-600 text-white text-sm font-semibold py-1 px-3 rounded transition duration-200 flex items-center"
                  >
                    <svg
                      class="w-4 h-4 mr-1"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                      xmlns="http://www.w3.org/2000/svg"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M12 4v16m8-8H4"
                      ></path>
                    </svg>
                    Nova Aula
                  </button>
                </div>

                <div class="overflow-x-auto rounded-lg shadow-inner">
                  <table class="min-w-full bg-gray-50">
                    <thead class="bg-indigo-500 text-white">
                      <tr>
                        <th class="py-2 px-4 text-left">Data da Aula</th>
                        <th class="py-2 px-4 text-center">Aula</th>
                        <th class="py-2 px-4 text-center">Presença</th>
                        <th class="py-2 px-4 text-left">Subject</th>
                        <th class="py-2 px-4">Ações</th>
                      </tr>
                    </thead>
                    <tbody id="classes-table-body">
                      <!-- Aulas serão injetadas aqui -->
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Mensagem de boas-vindas/vazio -->
        <div
          id="initial-message"
          class="text-center mt-20 p-8 bg-indigo-50 rounded-xl shadow-lg"
        >
          <svg
            class="w-16 h-16 mx-auto text-indigo-400"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
            xmlns="http://www.w3.org/2000/svg"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="1.5"
              d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
            ></path>
          </svg>
          <p class="mt-4 text-xl font-semibold text-indigo-600">
            Seu Gerenciador de Alunos de Inglês
          </p>
          <p class="mt-2 text-gray-500">
            Use o botão "Novo Aluno" para começar a registrar as informações,
            aulas e pagamentos.
          </p>
        </div>
      </div>
    </div>

    <!-- Modais -->

    <!-- Modal Base para Formulários (Aluno, Aula, Pagamento) -->
    <div
      id="generic-modal"
      class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center p-4 transition-opacity duration-300 opacity-0 pointer-events-none z-50"
    >
      <div
        class="bg-white rounded-xl shadow-2xl w-full max-w-lg transform transition-transform duration-300 scale-95 p-6"
      >
        <h3
          id="modal-title"
          class="text-2xl font-bold mb-4 text-indigo-700"
        ></h3>
        <div id="modal-content">
          <!-- O conteúdo específico (formulário) será injetado aqui -->
        </div>
      </div>
    </div>

    <!-- NOVO: Modal de Confirmação Customizado (Substitui confirm()) -->
    <div
      id="confirmation-modal"
      class="fixed inset-0 bg-gray-900 bg-opacity-70 flex items-center justify-center p-4 transition-opacity duration-300 opacity-0 pointer-events-none z-[60]"
    >
      <div
        class="bg-white rounded-xl shadow-2xl w-full max-w-sm transform transition-transform duration-300 scale-95 p-6"
      >
        <h3 class="text-xl font-bold mb-4 text-red-700">
          Confirmação Necessária
        </h3>
        <p id="confirm-message" class="text-gray-700 mb-6"></p>
        <div class="flex justify-end space-x-3">
          <button
            type="button"
            onclick="window.toggleConfirmModal(false)"
            class="px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 transition duration-150"
          >
            Cancelar
          </button>
          <button
            type="button"
            onclick="window.executeConfirmedAction()"
            class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition duration-150"
          >
            Confirmar Exclusão
          </button>
        </div>
      </div>
    </div>

    <!-- Mensagem de Feedback (para substituir alert()) -->
    <div
      id="message-box"
      class="fixed top-4 right-4 p-4 rounded-lg text-white shadow-lg transition-transform duration-300 transform translate-x-full z-50"
    ></div>

    <!-- Scripts do Supabase e App Logic -->
    <script type="module">
      import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

      // --- CONFIGURAÇÃO SUPABASE ---
      // SUAS CHAVES FORNECIDAS
      const SUPABASE_URL = "https://gzshumsrfmfugywgktaf.supabase.co";
      const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imd6c2h1bXNyZm1mdWd5d2drdGFmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIyODI4ODAsImV4cCI6MjA3Nzg1ODg4MH0.o76mhiZb-GYkJLugGOwC6SU3KcxENxOXx8IGPZmV0bQ";

      let client;
      let userId = "anon_user_for_supabase"; // ID fictício para o Supabase (Não é usado na lógica de exclusão)

      // Array de meses para o dropdown e ordenação
      const MONTHS = [
        "Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho",
        "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro",
      ];

      // Estado Global do App
      window.students = [];
      window.currentStudentId = null;
      window.currentStudent = null;
      window.currentSelectedMonth = null;
      let isSaving = false; // Flag para prevenir "race conditions"

      // --- FUNÇÕES DE UTILIDADE ---

      // Variáveis globais para o modal de confirmação
      window.pendingAction = null;
      window.pendingArgs = [];

      window.toggleConfirmModal = (show = true) => {
        const modal = document.getElementById("confirmation-modal");
        const content = modal.querySelector(".max-w-sm");
        if (show) {
          modal.classList.remove("pointer-events-none", "opacity-0");
          content.classList.remove("scale-95");
          content.classList.add("scale-100");
        } else {
          modal.classList.add("pointer-events-none", "opacity-0");
          content.classList.remove("scale-100");
          content.classList.add("scale-95");
          // Limpa a ação pendente após fechar
          window.pendingAction = null;
          window.pendingArgs = [];
        }
      };

      window.openConfirmModal = (message, actionFn, args) => {
        document.getElementById("confirm-message").textContent = message;
        window.pendingAction = actionFn;
        window.pendingArgs = args;
        window.toggleConfirmModal(true);
      };

      // Função que executa a ação de exclusão confirmada
      window.executeConfirmedAction = async () => {
        window.toggleConfirmModal(false);
        if (window.pendingAction) {
            console.error("EXECUTION CHECK: Attempting to run pending deletion action.");
          try {
              // Executa a função com argumentos
              await window.pendingAction(...window.pendingArgs);
          } catch(error) {
              console.error("ERRO CRÍTICO na execução da ação pendente:", error);
              showMessage("Erro grave na exclusão. Verifique o console.", "error");
          }
        }
      };

      function showMessage(message, type = "success") {
        const box = document.getElementById("message-box");
        box.textContent = message;
        box.className =
          "fixed top-4 right-4 p-4 rounded-lg text-white shadow-lg transition-transform duration-300 transform translate-x-full z-50";

        if (type === "success") {
          box.classList.add("bg-green-500");
        } else if (type === "error") {
          box.classList.add("bg-red-500");
        } else {
          box.classList.add("bg-blue-500");
        }

        setTimeout(() => {
          box.classList.remove("translate-x-0");
          box.classList.add("translate-x-full");
        }, 3000);
      }
      
      /**
       * Obtém o nome do mês a partir do índice (0=Janeiro, 11=Dezembro).
       * @param {number} monthIndex Índice do mês (0-11)
       * @returns {string} Nome do mês em português.
       */
      function getMonthName(monthIndex) {
        return MONTHS[monthIndex];
      }

      // Função para mostrar ou esconder o modal genérico
      window.toggleModal = (show = true) => {
        const modal = document.getElementById("generic-modal");
        const content = modal.querySelector(".max-w-lg");
        if (show) {
          modal.classList.remove("pointer-events-none", "opacity-0");
          content.classList.remove("scale-95");
          content.classList.add("scale-100");
          document.body.classList.add("overflow-hidden");
        } else {
          modal.classList.add("pointer-events-none", "opacity-0");
          content.classList.remove("scale-100");
          content.classList.add("scale-95");
          document.body.classList.remove("overflow-hidden");
        }
      };

      // --- SUPABASE E AUTENTICAÇÃO (MOCK) ---

      async function initSupabase() {
        try {
          // Inicializa o cliente Supabase
          client = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
          document.getElementById("supabase-status").textContent = "(Status Supabase: Conectado)";
          document.getElementById("user-id-display").textContent = userId;
          
          // Inicia a escuta de alterações em tempo real
          client
            .channel('public:students')
            .on('postgres_changes', { event: '*', schema: 'public', table: 'students' }, (payload) => {
                console.log('Supabase Realtime Change Detected:', payload.eventType);
                // Força a recarga da lista
                fetchStudents();
            })
            .subscribe();

          // Carrega os alunos inicialmente
          fetchStudents();

        } catch (error) {
          console.error("Erro ao inicializar Supabase:", error);
          document.getElementById("supabase-status").textContent = "(Status Supabase: Falha na Conexão)";
          showMessage("Erro ao inicializar Supabase. Verifique as chaves.", "error");
        }
      }

      // --- FUNÇÕES CRUD BÁSICAS (LEITURA) ---
      
      async function loadStudentsFromSupabase() {
          const { data, error } = await client
              .from('students')
              .select('*')
              // REMOVIDO: .eq('user_id', userId) para evitar o erro 42703
              .order('nome', { ascending: true }); // Ordena localmente

          if (error) {
              throw error;
          }
          return data;
      }

      async function fetchStudents() {
        if (!client) return;

        try {
            const data = await loadStudentsFromSupabase();
            
            // O onSnapshot do Firebase foi substituído pelo listener de realtime do Supabase
            // e a chamada manual acima. A renderização é feita aqui.

            if (isSaving) {
                console.warn("onSnapshot: Renderização pulada (salvando dados).");
                return; // Pula a renderização se estiver salvando
            }

            window.students = data.map((doc) => ({
                id: doc.id,
                ...doc,
            }));
            
            // CORREÇÃO: Ordena os alunos por nome antes de renderizar
            window.students.sort((a, b) => (a.nome || "").localeCompare(b.nome || ""));


            renderStudentList(window.students);

            // Re-seleciona o aluno atual após a atualização
            if (window.currentStudentId) {
                const updatedStudent = window.students.find(
                    (s) => s.id === window.currentStudentId
                );
                if (updatedStudent) {
                    selectStudent(updatedStudent);
                } else {
                    // Se o aluno foi excluído
                    resetDetailsView();
                }
            } else if (window.students.length > 0) {
                // Seleciona o primeiro aluno se nenhum estiver selecionado
                selectStudent(window.students[0]);
            } else {
                resetDetailsView();
            }

        } catch (error) {
            console.error("Erro ao carregar alunos:", error);
            showMessage("Não foi possível carregar os dados. Verifique a conexão/tabela.", "error");
        }
      }

      // --- FUNÇÕES DE RENDERIZAÇÃO DE UI ---

      function renderStudentList(students) {
        const listEl = document.getElementById("student-list");
        listEl.innerHTML = "";

        if (students.length === 0) {
          listEl.innerHTML =
            '<p class="text-gray-500 text-sm italic">Nenhum aluno cadastrado. Comece agora!</p>';
          return;
        }

        students.forEach((student) => {
          const isActive =
            student.id === window.currentStudentId
              ? "bg-indigo-100 border-indigo-500"
              : "bg-gray-50 hover:bg-gray-100 border-gray-200";

          const item = document.createElement("div");
          item.className = `p-3 rounded-lg border cursor-pointer transition duration-150 ${isActive}`;
          item.innerHTML = `<p class="font-semibold text-gray-800 truncate">${
            student.nome || "Aluno Sem Nome"
          }</p>
							<p class="text-xs text-gray-500">${
                student.plano || "Sem Plano"
              }</p>`;
          item.onclick = () => selectStudent(student);
          listEl.appendChild(item);
        });
      }

      // Função principal para seleção e renderização
      window.selectStudent = (student) => {
        window.currentStudentId = student.id;
        window.currentStudent = student;

        // 1. Atualiza lista e título
        renderStudentList(window.students);
        document.getElementById("main-title").textContent =
          student.nome || "Detalhes do Aluno";

        // 2. Exibe a seção de detalhes
        const contentEl = document.getElementById("student-details-content");
        contentEl.classList.remove("hidden", "opacity-0", "scale-95");
        contentEl.classList.add("opacity-100", "scale-100");
        document.getElementById("initial-message").classList.add("hidden");

        // 3. Renderiza Informações (Fixas)
        renderStudentInfo(student);

        // 4. Renderiza Abas de Mês e Filtra o Conteúdo (NOVO FLUXO)
        renderMonthTabs(student);
        // Chama selectMonth para garantir que o conteúdo filtrado seja exibido
        window.selectMonth(
          window.currentSelectedMonth || getMonthName(new Date().getMonth())
        );
      };

      function renderStudentInfo(student) {
        const infoMap = [
          { label: "e-mail", key: "email" },
          { label: "Início", key: "inicio" },
          { label: "Plano", key: "plano" },
          { label: "Valor Mensal", key: "valorMensal" },
          { label: "CPF", key: "cpf" }, // Adicionado o CPF aqui
          { label: "Horário", key: "horario" },
        ];

        const html = infoMap
          .map(
            (item) => `
                <div class="border-b pb-2">
                  <p class="text-xs font-medium text-gray-500">${
                    item.label
                  }</p>
                  <p class="text-base font-medium">${
                    student[item.key] || "N/A"
                  }</p>
                </div>
            `
          )
          .join("");

        document.getElementById("info-section").innerHTML = html;
      }

      // NOVO: Renderiza Dropdown de Meses
      function renderMonthTabs(student) {
        const dropdown = document.getElementById("month-dropdown");
        dropdown.innerHTML = ""; // Limpa opções anteriores

        const monthsSet = new Set();

        // Coletar meses das Aulas
        (student.aulas || []).forEach((aula) => {
          // O formato DD/MM/YYYY precisa ser invertido para YYYY-MM-DD para Date() funcionar
          const dateParts = aula.data.split('/');
          if (dateParts.length === 3) {
            const yyyymmdd = `${dateParts[2]}-${dateParts[1]}-${dateParts[0]}`;
            const date = new Date(yyyymmdd + "T00:00:00");
            if (!isNaN(date)) {
              monthsSet.add(getMonthName(date.getMonth()));
            }
          }
        });

        // Coletar meses das Mensalidades
        (student.mensalidades || []).forEach((pagamento) => {
          if (pagamento.mes) {
            monthsSet.add(pagamento.mes);
          }
        });

        const sortedMonths = Array.from(monthsSet).sort((a, b) => {
          return MONTHS.indexOf(a) - MONTHS.indexOf(b);
        });

        if (sortedMonths.length === 0) {
          dropdown.innerHTML =
            '<option value="">Nenhum mês disponível</option>';
          window.currentSelectedMonth = null;
          return;
        }

        // Define o mês inicial (último mês com dados ou o mês atual se não houver seleção prévia)
        let selectedMonth = window.currentSelectedMonth;
        if (
          !selectedMonth ||
          !sortedMonths.includes(selectedMonth)
        ) {
          selectedMonth = sortedMonths[sortedMonths.length - 1];
          window.currentSelectedMonth = selectedMonth;
        }

        // Renderiza as opções do dropdown
        sortedMonths.forEach((month) => {
          const selected = month === selectedMonth ? "selected" : "";

          dropdown.innerHTML += `
            <option value="${month}" ${selected}>${month}</option>
          `;
        });
      }

      // NOVO: Função que filtra e renderiza o conteúdo principal
      window.selectMonth = (month) => {
        window.currentSelectedMonth = month;
        
        // Atualiza o valor do dropdown para refletir a seleção (caso tenha vindo de fora)
        const dropdown = document.getElementById("month-dropdown");
        if (dropdown) {
            dropdown.value = month;
        }

        const student = window.currentStudent;
        if (!student) return;

        // 1. Filtrar Mensalidades
        const filteredPayments = (student.mensalidades || []).filter(
          (pagamento) => {
            return pagamento.mes === month;
          }
        );

        // 2. Filtrar Aulas
        const filteredClasses = (student.aulas || []).filter((aula) => {
          if (!aula.data) return false;
          
          // CORREÇÃO: Inverte a data de DD/MM/YYYY (armazenada) para YYYY-MM-DD (para objeto Date)
          const dateParts = aula.data.split('/');
          if (dateParts.length !== 3) return false;

          const yyyymmdd = `${dateParts[2]}-${dateParts[1]}-${dateParts[0]}`;
          const date = new Date(yyyymmdd + "T00:00:00");
          
          if (isNaN(date)) return false;

          return getMonthName(date.getMonth()) === month;
        });

        // 3. Renderizar Seções com dados filtrados
        renderPayments(filteredPayments); // RENDERIZAÇÃO DE PAGAMENTOS
        renderClasses(filteredClasses); // RENDERIZAÇÃO DE AULAS
      };

      // O renderClasses agora aceita a lista de aulas filtrada
      function renderClasses(filteredAulas) {
        const tbody = document.getElementById("classes-table-body");
        tbody.innerHTML = "";

        if (filteredAulas.length === 0) {
          tbody.innerHTML =
            '<tr><td colspan="5" class="text-center py-4 text-gray-500 italic">Nenhuma aula registrada neste mês.</td></tr>';
          return;
        }

        // Ordena as aulas por data (simplesmente inverte para mostrar as mais recentes primeiro)
        const sortedAulas = [...filteredAulas].reverse();

        sortedAulas.forEach((aula, index) => {
          const presenceIcon = aula.presente
            ? '<svg class="w-5 h-5 text-green-500 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>'
            : '<svg class="w-5 h-5 text-red-500 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>';

          // Encontra o índice original no array COMPLETO para permitir a edição/exclusão correta
          const originalIndex = window.currentStudent.aulas.findIndex(
            (a) =>
              a.data === aula.data &&
              a.aula === aula.aula &&
              a.subject === aula.subject
          );

          tbody.innerHTML += `
                    <tr class="border-b hover:bg-gray-100">
                        <td class="py-3 px-4 text-sm">${
                          aula.data || "N/A"
                        }</td>
                        <td class="py-3 px-4 text-center text-sm font-medium">${
                          aula.aula || "N/A"
                        }</td>
                        <td class="py-3 px-4 text-center">${presenceIcon}</td>
                        <td class="py-3 px-4 text-sm">${
                          aula.subject || "N/A"
                        }</td>
                        <td class="py-3 px-4 text-center space-x-2">
                            <button onclick="window.openClassModal(${originalIndex})" class="text-indigo-500 hover:text-indigo-700 text-xs">Editar</button>
                            <!-- ATUALIZAÇÃO: Trocado "Excluir" por um ícone X -->
                            <button onclick="window.deleteClass(${originalIndex})" title="Excluir Aula" class="text-red-500 hover:text-red-700 p-1 rounded-full hover:bg-red-100 transition duration-150">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                            </button>
                        </td>
                    </tr>
                `;
        });
      }

      // O renderPayments agora aceita a lista de pagamentos filtrada
      function renderPayments(filteredMensalidades) {
        const tbody = document.getElementById("payments-table-body");
        tbody.innerHTML = "";

        if (filteredMensalidades.length === 0) {
          tbody.innerHTML =
            '<tr><td colspan="4" class="text-center py-4 text-gray-500 italic">Nenhum pagamento registrado neste mês.</td></tr>';
          return;
        }

        // Não inverte a ordem pois só deve haver 1 pagamento por mês filtrado

        filteredMensalidades.forEach((pagamento) => {
          // Adiciona a classe 'unpaid-row' se não estiver pago
          const rowClass = pagamento.pago ? "hover:bg-gray-100" : "unpaid-row";

          const paidIcon = pagamento.pago
            ? '<svg class="w-5 h-5 text-green-500 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>'
            : '<svg class="w-5 h-5 text-red-600 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>'; // Ícone de X para não pago

          // Encontra o índice original no array COMPLETO para permitir a edição/exclusão correta
          const originalIndex = window.currentStudent.mensalidades.findIndex(
            (p) => p.mes === pagamento.mes
          );

          tbody.innerHTML += `
                    <tr class="border-b ${rowClass}">
                        <td class="py-3 px-4 text-sm font-medium">${
                          pagamento.mes || "N/A"
                        }</td>
                        <td class="py-3 px-4 text-center">${paidIcon}</td>
                        <td class="py-3 px-4 text-sm">${
                          pagamento.pago
                            ? pagamento.diaPago || "N/A"
                            : "NÃO PAGO"
                        }</td>
                        <td class="py-3 px-4 text-center space-x-2">
                            <button onclick="window.openPaymentModal(${originalIndex})" class="text-indigo-500 hover:text-indigo-700 text-xs">Editar</button>
                            <!-- ATUALIZAÇÃO: Trocado "Excluir" por um ícone X -->
                            <button onclick="window.deletePayment(${originalIndex})" title="Excluir Pagamento" class="text-red-500 hover:text-red-700 p-1 rounded-full hover:bg-red-100 transition duration-150">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                            </button>
                        </td>
                    </tr>
                `;
        });
      }

      function resetDetailsView() {
        document.getElementById("initial-message").classList.remove("hidden");
        const contentEl = document.getElementById("student-details-content");
        contentEl.classList.add("hidden", "opacity-0", "scale-95");
        document.getElementById("main-title").textContent =
          "Selecione um Aluno";
        window.currentStudentId = null;
        window.currentStudent = null;
        window.currentSelectedMonth = null; // Limpa o mês selecionado
        renderStudentList(window.students);
      }

      // --- FUNÇÕES CRUD (ESCRITA) ---
      
      // 1. Alunos (Alterado para usar o Modal de Confirmação e AGORA USA UMA FASE SÓ)
      window.openStudentModal = (student = null) => {
        const title = student
          ? `Editar Aluno: ${student.nome}`
          : "Adicionar Novo Aluno";
        // Adicionado campo 'cpf' ao objeto de dados
        const data = student || {
          nome: "",
          email: "",
          inicio: "",
          plano: "",
          valorMensal: "",
          cpf: "",
          horario: "",
        };

        document.getElementById("modal-title").textContent = title;
        document.getElementById("modal-content").innerHTML = `
                <form id="student-form" onsubmit="event.preventDefault(); window.saveStudent('${
                  student ? student.id : ""
                }')" class="space-y-4">
                    <div>
                        <label for="nome" class="block text-sm font-medium text-gray-700">Nome do Aluno</label>
                        <input type="text" id="nome" value="${
                          data.nome || ''
                        }" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div>
                        <label for="email" class="block text-sm font-medium text-gray-700">E-mail</label>
                        <input type="email" id="email" value="${
                          data.email || ''
                        }" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="inicio" class="block text-sm font-medium text-gray-700">Início (Ex: 25/7/2023)</label>
                            <input type="text" id="inicio" value="${
                              data.inicio || ''
                            }" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                        <div>
                            <label for="plano" class="block text-sm font-medium text-gray-700">Plano (Ex: 2x /week)</label>
                            <input type="text" id="plano" value="${
                              data.plano || ''
                            }" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="valorMensal" class="block text-sm font-medium text-gray-700">Valor Mensal (Ex: R$ 500)</label>
                            <input type="text" id="valorMensal" value="${
                              data.valorMensal || ''
                            }" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                        <div>
                            <label for="cpf" class="block text-sm font-medium text-gray-700">CPF</label>
                            <input type="text" id="cpf" value="${
                              data.cpf || ''
                            }" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                    </div>
                    <div class="grid grid-cols-1">
                        <div>
                            <label for="horario" class="block text-sm font-medium text-gray-700">Horário (Ex: terças e quintas 18hrs)</label>
                            <input type="text" id="horario" value="${
                              data.horario || ''
                            }" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                    </div>
                    
                    <!-- ATUALIZAÇÃO: Layout dos botões do formulário alterado -->
                    <div class="flex justify-between items-center pt-4">
                        <div> <!-- Botão Excluir (Lixeira) à esquerda -->
                            ${
                              student
                                ? `<button type="button" onclick="window.deleteStudent('${student.id}', '${student.nome}')" title="Excluir Aluno" class="text-red-600 hover:text-red-800 font-medium p-2 rounded-lg hover:bg-red-50 transition duration-150 flex items-center">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                                <span class="ml-1 text-sm">Excluir Aluno</span>
                            </button>`
                                : "<div></div>"
                            }
                        </div>
                        <div class="space-x-3"> <!-- Botões Cancelar/Salvar à direita -->
                            <button type="button" onclick="window.toggleModal(false)" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 transition duration-150">Cancelar</button>
                            <button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 transition duration-150">${
                              student ? "Salvar Alterações" : "Adicionar"
                            }</button>
                        </div>
                    </div>
                </form>
            `;
        window.toggleModal(true);
      };

      window.saveStudent = async (studentId) => {
        const form = document.getElementById("student-form");
        const submitButton = form.querySelector('button[type="submit"]');

        if (!form.checkValidity()) {
          form.reportValidity();
          return;
        }

        submitButton.disabled = true;
        submitButton.textContent = "Salvando...";
        isSaving = true;

        const newStudentData = {
          nome: form.querySelector("#nome").value,
          email: form.querySelector("#email").value,
          inicio: form.querySelector("#inicio").value,
          plano: form.querySelector("#plano").value,
          valorMensal: form.querySelector("#valorMensal").value,
          cpf: form.querySelector("#cpf").value,
          horario: form.querySelector("#horario").value,
          // user_id: userId, // Não é usado para evitar erros de esquema/permissão
        };

        const isNewStudent = !studentId;
        const finalStudentId = isNewStudent ? crypto.randomUUID() : studentId;
        
        // 1. FASE UPSERT (MÍNIMO: id, nome, email, arrays) - PARA SATISFAZER NOT NULL E EVITAR ERROS DE CACHE EM CAMELCASE
        const upsertPayload = {
            id: finalStudentId,
            nome: newStudentData.nome, // CRÍTICO: Incluído para satisfazer NOT NULL
            email: newStudentData.email,
            // Inclui arrays existentes para evitar limpá-los no UPSERT
            aulas: window.currentStudent ? window.currentStudent.aulas : [],
            mensalidades: window.currentStudent ? window.currentStudent.mensalidades : [],
        };
        
        // 2. FASE UPDATE (COMPLETO: Todos os campos que causaram problemas PGRST204)
        const updatePayload = {
            inicio: newStudentData.inicio,
            plano: newStudentData.plano,
            valorMensal: newStudentData.valorMensal, // MOVIDO PARA CÁ
            cpf: newStudentData.cpf,
            horario: newStudentData.horario,
        };
        
        try {
          // 1. Operação UPSERT MÍNIMA
          let { error: upsertError } = await client
            .from('students')
            .upsert(upsertPayload, { onConflict: 'id' }); // onConflict: 'id' é necessário para tratar a edição

          if (upsertError) {
            throw new Error(`Supabase Upsert Error: ${upsertError.message}`);
          }
          
          // 2. Operação UPDATE COMPLETA (para campos de camelCase)
          let { error: updateError } = await client
            .from('students')
            .update(updatePayload)
            .eq('id', finalStudentId);

          if (updateError) {
            throw new Error(`Supabase Update Error: ${updateError.message}`);
          }


          window.toggleModal(false);
          showMessage(`Aluno ${newStudentData.nome} salvo com sucesso!`);

          if (isNewStudent) {
            window.currentStudentId = finalStudentId;
          }

        } catch (e) {
          console.error("Erro ao salvar aluno (Supabase): ", e);
          showMessage(`Erro ao salvar. Tente novamente. ${e.message}`, "error");

          submitButton.disabled = false;
          submitButton.textContent = isNewStudent
            ? "Adicionar"
            : "Salvar Alterações";
        } finally {
          isSaving = false;
          // O Realtime fará a atualização da lista
        }
      };

      // FUNÇÃO ATUALIZADA: Exclui o aluno inteiro
      window.deleteStudent = async (studentId, studentName) => {
        window.openConfirmModal(
          `Você tem certeza que deseja EXCLUIR o aluno "${studentName}" e TODOS os seus dados? Esta ação é irreversível.`,
          async (id, name) => {
            try {
              console.error("CRITICAL PATH CHECK - DELETE STUDENT. ID:", id);
              
              const { error } = await client
                .from('students')
                .delete()
                .eq('id', id);

              if (error) {
                throw error;
              }

              window.toggleModal(false); // Fecha o modal de aluno/edição
              showMessage(`Aluno ${name} excluído!`);

            } catch (e) {
              console.error("ERRO CRÍTICO ao excluir aluno:", e);
              showMessage(`Falha na exclusão. Verifique as Regras de Segurança do Supabase. Erro: ${e.message}`, "error"); 
            }
          },
          [studentId, studentName]
        );
      };

      // 2. Aulas (atualizada para usar Supabase)
      window.openClassModal = (classIndex = -1) => {
        if (!window.currentStudent) {
          showMessage("Selecione um aluno primeiro.", "error");
          return;
        }

        const isEditing = classIndex !== -1;
        // Data formatada como YYYY-MM-DD para o input
        const today = new Date().toISOString().split("T")[0];
        
        // CORREÇÃO: Se estiver editando, converte a data de DD/MM/YYYY (armazenada) para YYYY-MM-DD (input)
        let dataInput = today;
        if (isEditing && window.currentStudent.aulas[classIndex].data) {
            const parts = window.currentStudent.aulas[classIndex].data.split('/');
            if (parts.length === 3) {
                dataInput = `${parts[2]}-${parts[1]}-${parts[0]}`;
            } else {
                dataInput = window.currentStudent.aulas[classIndex].data; // Mantém se já for YYYY-MM-DD
            }
        }
        
        const existingClass = isEditing
          ? window.currentStudent.aulas[classIndex]
          : { data: dataInput, aula: "1ª", presente: true, subject: "" };

        // Opções para o dropdown de sequência de aulas
        const classOptions = Array.from({ length: 10 }, (_, i) => {
          const aulaText = `${i + 1}ª`;
          const selected = existingClass.aula === aulaText ? "selected" : "";
          return `<option value="${aulaText}" ${selected}>${aulaText} Aula</option>`;
        }).join("");

        document.getElementById("modal-title").textContent = isEditing
          ? "Editar Aula"
          : "Adicionar Nova Aula";
        document.getElementById("modal-content").innerHTML = `
                <form id="class-form" onsubmit="event.preventDefault(); window.saveClass(${classIndex})" class="space-y-4">
                    <div>
                        <label for="class-data" class="block text-sm font-medium text-gray-700">Data da Aula</label>
                        <input type="date" id="class-data" value="${
                          dataInput
                        }" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div>
                        <label for="class-number" class="block text-sm font-medium text-gray-700">Sequência da Aula</label>
                        <select id="class-number" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:ring-indigo-500 focus:border-indigo-500">
                            ${classOptions}
                        </select>
                    </div>
                    <div>
                        <label for="class-subject" class="block text-sm font-medium text-gray-700">Subject (Ex: Simple Past)</label>
                        <input type="text" id="class-subject" value="${
                          existingClass.subject || ''
                        }" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div class="flex items-center">
                        <input type="checkbox" id="class-presente" ${
                          existingClass.presente ? "checked" : ""
                        } class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                        <label for="class-presente" class="ml-2 block text-sm font-medium text-gray-700">Presente (Concluída)</label>
                    </div>

                    <div class="flex justify-end pt-4 space-x-3">
                        <button type="button" onclick="window.toggleModal(false)" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 transition duration-150">Cancelar</button>
                        <button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 transition duration-150">${
                          isEditing ? "Salvar Aula" : "Adicionar Aula"
                        }</button>
                    </div>
                </form>
            `;
        window.toggleModal(true);
      };

      window.saveClass = async (classIndex) => {
        const form = document.getElementById("class-form");
        const submitButton = form.querySelector('button[type="submit"]');

        if (!form.checkValidity()) return;
        if (!window.currentStudentId) {
          showMessage("Erro: Nenhum aluno selecionado.", "error");
          return;
        }

        submitButton.disabled = true;
        isSaving = true;

        const dataInput = form.querySelector("#class-data").value;
        
        // CORREÇÃO CRÍTICA: Converte YYYY-MM-DD do input de volta para DD/MM/YYYY para salvar
        const [year, month, day] = dataInput.split('-');
        const formattedDate = `${day}/${month}/${year}`;
        
        const newClass = {
          data: formattedDate, // Salva no formato DD/MM/YYYY
          aula: form.querySelector("#class-number").value,
          subject: form.querySelector("#class-subject").value,
          presente: form.querySelector("#class-presente").checked,
        };

        const aulas = [...(window.currentStudent.aulas || [])];

        if (classIndex !== -1) {
          // Editar aula existente
          aulas[classIndex] = newClass;
        } else {
          // Adicionar nova aula (adiciona no final)
          aulas.push(newClass);
        }

        try {
          const { error } = await client
            .from('students')
            .update({ aulas: aulas })
            .eq('id', window.currentStudentId);

          if (error) {
            throw error;
          }
          
          window.toggleModal(false);
          showMessage(`Aula salva com sucesso!`);

          // ATUALIZAÇÃO NOVO FLUXO: Seleciona o mês da aula recém-salva
          const date = new Date(dataInput + "T00:00:00");
          const monthName = getMonthName(date.getMonth());
          window.currentSelectedMonth = monthName;

        } catch (e) {
          console.error("Erro ao salvar aula:", e);
          showMessage(`Erro ao salvar aula. Erro: ${e.message}`, "error");
          submitButton.disabled = false;
        } finally {
          isSaving = false;
        }
      };

      // FUNÇÃO ATUALIZADA: Exclui Aula (Supabase)
      window.deleteClass = async (classIndex) => {
        if (!window.currentStudentId) {
          showMessage("Erro: Nenhum aluno selecionado.", "error");
          return;
        }

        window.openConfirmModal(
          `Você tem certeza que deseja EXCLUIR permanentemente esta aula?`,
          async (index) => {
            try {
              console.error("CRITICAL PATH CHECK - DELETE CLASS. Student ID:", window.currentStudentId);
              const aulas = [...(window.currentStudent.aulas || [])];
              aulas.splice(index, 1);

              const { error } = await client
                .from('students')
                .update({ aulas: aulas })
                .eq('id', window.currentStudentId);

              if (error) {
                throw error;
              }
              
              showMessage(`Aula excluída!`);
              // O Realtime listener do Supabase faz o resto
            } catch (e) {
              console.error("ERRO CRÍTICO ao excluir aula:", e);
              showMessage(`Falha na exclusão da aula. Erro: ${e.message}`, "error");
            }
          },
          [classIndex]
        );
      };

      // 3. Mensalidades (atualizada para usar Supabase)

      window.openPaymentModal = (paymentIndex = -1) => {
        if (!window.currentStudent) {
          showMessage("Selecione um aluno primeiro.", "error");
          return;
        }

        const isEditing = paymentIndex !== -1;
        const existingPayment = isEditing
          ? window.currentStudent.mensalidades[paymentIndex]
          : { mes: MONTHS[new Date().getMonth()], pago: true, diaPago: "" };

        // Cria as opções do dropdown de meses
        const monthOptions = MONTHS.map((month) => {
          const selected = existingPayment.mes === month ? "selected" : "";
          return `<option value="${month}" ${selected}>${month}</option>`;
        }).join("");

        document.getElementById("modal-title").textContent = isEditing
          ? "Editar Pagamento"
          : "Registrar Novo Pagamento";
        document.getElementById("modal-content").innerHTML = `
                <form id="payment-form" onsubmit="event.preventDefault(); window.savePayment(${paymentIndex})" class="space-y-4">
                    <div>
                        <label for="payment-month" class="block text-sm font-medium text-gray-700">Mês</label>
                        <select id="payment-month" ${isEditing ? 'disabled' : ''} required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:ring-indigo-500 focus:border-indigo-500 ${isEditing ? 'bg-gray-100' : ''}">
                            ${monthOptions}
                        </select>
                        ${isEditing ? '<p class="text-xs text-gray-500 mt-1">Mês não pode ser alterado durante a edição.</p>' : ''}
                    </div>

                    <div class="flex items-center space-x-4">
                        <div class="flex items-center">
                            <input type="checkbox" id="payment-paid" onchange="window.togglePaymentDay()" ${
                              existingPayment.pago ? "checked" : ""
                            } class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                            <label for="payment-paid" class="ml-2 block text-sm font-medium text-gray-700">Pagamento Recebido</label>
                        </div>
                        
                        <div id="payment-day-container" class="${
                          existingPayment.pago ? "" : "hidden"
                        } flex-grow">
                            <label for="payment-day" class="block text-sm font-medium text-gray-700">Dia Pago (Ex: 20)</label>
                            <input type="number" id="payment-day" min="1" max="31" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                    </div>

                    <div class="flex justify-end pt-4 space-x-3">
                        <button type="button" onclick="window.toggleModal(false)" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 transition duration-150">Cancelar</button>
                        <button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 transition duration-150">${
                          isEditing ? "Salvar Pagamento" : "Registrar Pagamento"
                        }</button>
                    </div>
                </form>
            `;

        document.getElementById("payment-day").value =
          existingPayment.diaPago || "";

        window.toggleModal(true);
        // Garante que o estado inicial do dia pago está correto (caso o input seja alterado dinamicamente)
        window.togglePaymentDay(); 
      };

      window.togglePaymentDay = () => {
        const paidCheckbox = document.getElementById("payment-paid");
        const dayContainer = document.getElementById("payment-day-container");
        const dayInput = document.getElementById("payment-day");

        if (paidCheckbox.checked) {
          dayContainer.classList.remove("hidden");
          // Sugere o dia atual para o campo diaPago
          if (!dayInput.value) {
            dayInput.value = new Date().getDate();
          }
        } else {
          dayContainer.classList.add("hidden");
          dayInput.value = ""; // Limpa o dia pago se o status for "Não Pago"
        }
      };

      window.savePayment = async (paymentIndex) => {
        const form = document.getElementById("payment-form");
        const submitButton = form.querySelector('button[type="submit"]');

        if (!form.checkValidity()) return;
        if (!window.currentStudentId) {
          showMessage("Erro: Nenhum aluno selecionado.", "error");
          return;
        }

        submitButton.disabled = true;
        isSaving = true;

        const isPaid = form.querySelector("#payment-paid").checked;
        const month = form.querySelector("#payment-month").value;
        const diaPagoValue = form.querySelector("#payment-day").value;
        
        const newPayment = {
          mes: month,
          pago: isPaid,
          // Salva o dia pago apenas se estiver pago, caso contrário, salva uma string vazia
          diaPago: isPaid ? diaPagoValue : "",
        };

        const mensalidades = [...(window.currentStudent.mensalidades || [])];

        if (paymentIndex !== -1) {
          // Editar pagamento existente
          mensalidades[paymentIndex] = newPayment;
        } else {
          // Checagem de duplicidade: se o mês já existe, trata como edição
          const existingIndex = mensalidades.findIndex(p => p.mes === month);
          if (existingIndex !== -1) {
              mensalidades[existingIndex] = newPayment;
              showMessage(`Pagamento para ${month} atualizado (mês já existia)!`);
          } else {
              // Adicionar novo pagamento (adiciona no final)
              mensalidades.push(newPayment);
          }
        }

        try {
          const { error } = await client
            .from('students')
            .update({ mensalidades: mensalidades })
            .eq('id', window.currentStudentId);
          
          if (error) {
              throw error;
          }
          
          window.toggleModal(false);
          showMessage(`Pagamento salvo com sucesso!`);

          // ATUALIZAÇÃO NOVO FLUXO: Seleciona o mês recém-salvo
          window.currentSelectedMonth = month;
          
        } catch (e) {
          console.error("Erro ao salvar pagamento:", e);
          showMessage(`Erro ao salvar pagamento. Erro: ${e.message}`, "error");
          submitButton.disabled = false;
        } finally {
          isSaving = false;
        }
      };

      // FUNÇÃO ATUALIZADA: Exclui Pagamento (Supabase)
      window.deletePayment = async (paymentIndex) => {
        if (!window.currentStudentId) {
          showMessage("Erro: Nenhum aluno selecionado.", "error");
          return;
        }

        window.openConfirmModal(
          `Você tem certeza que deseja EXCLUIR permanentemente este registro de pagamento?`,
          async (index) => {
            try {
              console.error("CRITICAL PATH CHECK - DELETE PAYMENT. Student ID:", window.currentStudentId);
              const mensalidades = [...(window.currentStudent.mensalidades || [])];
              mensalidades.splice(index, 1);

              const { error } = await client
                .from('students')
                .update({ mensalidades: mensalidades })
                .eq('id', window.currentStudentId);

              if (error) {
                throw error;
              }
              
              showMessage(`Pagamento excluído!`);
              // O Realtime listener do Supabase faz o resto
            } catch (e) {
              console.error("ERRO CRÍTICO ao excluir pagamento:", e);
              showMessage(`Falha na exclusão do pagamento. Erro: ${e.message}`, "error");
            }
          },
          [paymentIndex]
        );
      };
      
      // --- INICIALIZAÇÃO ---
      window.onload = initSupabase;
    </script>
  </body>
</html>
